<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán Nghe Ti·∫øng Anh</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .mode-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .mode-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .mode-button.active {
            background: linear-gradient(45deg, #e67e22, #d35400);
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .add-button,
        .import-button,
        .export-button,
        .sync-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 14px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .export-button {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .sync-button {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .add-button:hover,
        .import-button:hover,
        .export-button:hover,
        .sync-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .sentence-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.3s ease;
        }

        .sentence-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .english-line {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .english-text {
            flex: 1;
            font-size: 18px;
            color: #2c3e50;
            line-height: 1.5;
            min-height: 25px;
            outline: none;
            border: none;
            background: transparent;
            font-weight: 500;
        }

        .english-text:focus {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 5px;
        }

        .play-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .play-button:hover {
            background: linear-gradient(45deg, #2980b9, #3498db);
            transform: scale(1.1);
        }

        .vietnamese-text {
            font-size: 16px;
            color: #7f8c8d;
            line-height: 1.5;
            min-height: 22px;
            outline: none;
            border: none;
            background: transparent;
            width: 100%;
            font-style: italic;
        }

        .vietnamese-text:focus {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 5px;
        }

        .delete-button {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .delete-button:hover {
            opacity: 1;
            transform: scale(1.1);
            background: linear-gradient(45deg, #c0392b, #e74c3c);
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Status indicator */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            color: white;
            font-size: 12px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-connected {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .status-disconnected {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .status-syncing {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        /* Import modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .json-input {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            outline: none;
            resize: vertical;
        }

        .json-input:focus {
            border-color: #3498db;
        }

        /* Test Mode Styles */
        .test-container {
            display: none;
        }

        .test-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .test-progress {
            margin-bottom: 15px;
            font-size: 18px;
            color: #2c3e50;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            width: 0%;
        }

        .test-question {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .question-number {
            font-size: 18px;
            color: #3498db;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .test-play-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .test-play-button:hover {
            transform: scale(1.1);
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s ease;
            margin-bottom: 20px;
        }

        .answer-input:focus {
            border-color: #3498db;
        }

        .test-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-button {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-button:hover:not(:disabled) {
            background: linear-gradient(45deg, #7f8c8d, #95a5a6);
            transform: translateY(-1px);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-button {
            background: linear-gradient(45deg, #e67e22, #d35400);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Results Styles */
        .results-container {
            display: none;
        }

        .results-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .score-display {
            font-size: 3em;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 10px;
        }

        .score-text {
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .result-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .result-correct {
            border-left: 5px solid #27ae60;
        }

        .result-incorrect {
            border-left: 5px solid #e74c3c;
        }

        .result-question {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .result-answer {
            margin-bottom: 5px;
        }

        .user-answer {
            color: #e74c3c;
            font-style: italic;
        }

        .correct-answer {
            color: #27ae60;
            font-weight: bold;
        }

        .bold-text {
            font-weight: bold !important;
        }

        /* Animation cho card m·ªõi */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .new-card {
            animation: slideIn 0.5s ease;
        }

        /* Loading animation */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading {
            animation: spin 1s linear infinite;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2em;
            }

            .mode-buttons,
            .control-buttons {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .sentence-card {
                padding: 20px;
            }

            .english-line {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .play-button {
                align-self: flex-end;
                width: 40px;
                height: 40px;
            }

            .test-navigation {
                flex-direction: column;
                gap: 10px;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- Status Indicator -->
    <div id="status-indicator" class="status-indicator status-disconnected">
        üî¥ Kh√¥ng k·∫øt n·ªëi
    </div>

    <div class="container">
        <h1>üéß Luy·ªán Nghe Ti·∫øng Anh</h1>

        <div class="mode-buttons">
            <button class="mode-button active" onclick="showPracticeMode()">
                üìù Luy·ªán T·∫≠p
            </button>
            <button class="mode-button" onclick="showTestMode()">
                üéØ Ki·ªÉm Tra
            </button>
        </div>

        <!-- Practice Mode -->
        <div id="practice-container">
            <div class="instructions">
                üí° Nh·∫•n <strong>Ctrl + B</strong> ƒë·ªÉ in ƒë·∫≠m vƒÉn b·∫£n ƒë√£ ch·ªçn
            </div>

            <div class="control-buttons">
                <button class="add-button" onclick="addNewSentence()">
                    ‚ûï Th√™m C√¢u
                </button>
                <button class="import-button" onclick="showImportModal()">
                    üìÅ Nh·∫≠p JSON
                </button>
                <button class="export-button" onclick="exportToJSON()">
                    üíæ Xu·∫•t JSON
                </button>
                <button class="sync-button" onclick="syncWithFirebase()">
                    ‚òÅÔ∏è ƒê·ªìng B·ªô
                </button>
            </div>

            <div id="sentences-container">
                <!-- C√¢u m·∫´u s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
            </div>
        </div>

        <!-- Test Mode -->
        <div id="test-container" class="test-container">
            <div class="test-header">
                <div class="test-progress">
                    C√¢u <span id="current-question">1</span> / <span id="total-questions">20</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <div class="test-question">
                <div class="question-number">C√¢u <span id="question-number">1</span></div>
                <button class="test-play-button" onclick="playTestAudio()">
                    üîä
                </button>
                <input type="text" class="answer-input" id="answer-input"
                    placeholder="Nh·∫≠p c√¢u ti·∫øng Anh b·∫°n nghe ƒë∆∞·ª£c...">

                <div class="test-navigation">
                    <button class="nav-button" id="prev-button" onclick="previousQuestion()" disabled>
                        ‚Üê C√¢u tr∆∞·ªõc
                    </button>
                    <button class="nav-button" id="next-button" onclick="nextQuestion()">
                        C√¢u ti·∫øp ‚Üí
                    </button>
                    <button class="submit-button" id="submit-button" onclick="submitTest()" style="display: none;">
                        üìù N·ªôp B√†i
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results-container" class="results-container">
            <div class="results-header">
                <div class="score-display" id="score-display">0/20</div>
                <div class="score-text">ƒêi·ªÉm s·ªë c·ªßa b·∫°n</div>
                <button class="mode-button" onclick="showPracticeMode()" style="margin-top: 20px;">
                    üîÑ Quay l·∫°i luy·ªán t·∫≠p
                </button>
                <button class="mode-button" onclick="retakeTest()" style="margin-top: 20px;">
                    üéØ L√†m l·∫°i ki·ªÉm tra
                </button>
            </div>
            <div id="results-details"></div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeImportModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #2c3e50;">üìÅ Nh·∫≠p D·ªØ Li·ªáu JSON</h2>
            <p style="margin-bottom: 15px; color: #7f8c8d;">D√°n n·ªôi dung file JSON ho·∫∑c t·∫£i l√™n file:</p>

            <textarea id="json-input" class="json-input" placeholder='[
  {
    "english": "Hello, how are you?",
    "vietnamese": "Xin ch√†o, b·∫°n kh·ªèe kh√¥ng?"
  },
  {
    "english": "What time is it?",
    "vietnamese": "M·∫•y gi·ªù r·ªìi?"
  }
]'></textarea>

            <div style="margin: 20px 0; text-align: center;">
                <strong>HO·∫∂C</strong>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <input type="file" id="json-file-input" accept=".json" style="display: none;"
                    onchange="loadJSONFile(this)">
                <button onclick="document.getElementById('json-file-input').click()" class="import-button">
                    üìÇ Ch·ªçn File JSON
                </button>
            </div>

            <div style="text-align: center; gap: 10px; display: flex; justify-content: center;">
                <button onclick="importFromJSON()" class="add-button">
                    ‚úÖ Nh·∫≠p D·ªØ Li·ªáu
                </button>
                <button onclick="closeImportModal()" class="nav-button">
                    ‚ùå H·ªßy
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBrJh1921kNKJq6EF0U76pBD_VaGChgQqk",
        authDomain: "hz-listening.firebaseapp.com",
        projectId: "hz-listening",
        storageBucket: "hz-listening.firebasestorage.app",
        messagingSenderId: "1044959632237",
        appId: "1:1044959632237:web:d2fcc1294a83ca5349d864",
        measurementId: "G-SEY2ERMPDW"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let testQuestions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let firebaseConnected = false;

    // Firebase connection status
    function updateConnectionStatus(connected) {
        firebaseConnected = connected;
        const indicator = document.getElementById('status-indicator');

        if (connected) {
            indicator.className = 'status-indicator status-connected';
            indicator.innerHTML = 'üü¢ ƒê√£ k·∫øt n·ªëi';
        } else {
            indicator.className = 'status-indicator status-disconnected';
            indicator.innerHTML = 'üî¥ Kh√¥ng k·∫øt n·ªëi';
        }
    }

    // H√†m th·ª≠ t·∫£i t·ª´ Firebase v·ªõi timeout v√† retry
    async function tryLoadFromFirebase(maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                console.log(`üîÑ Firebase connection attempt ${attempt}/${maxRetries}`);
                
                // Set timeout cho vi·ªác k·∫øt n·ªëi Firebase
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Firebase timeout')), 8000)
                );
                
                const loadPromise = db.collection('sentences').doc('user_data').get();
                
                // Race between timeout and actual load
                const doc = await Promise.race([loadPromise, timeoutPromise]);
                
                updateConnectionStatus(true);
                
                if (doc.exists) {
                    const data = doc.data();
                    if (data.sentences && Array.isArray(data.sentences) && data.sentences.length > 0) {
                        loadSentencesToContainer(data.sentences);
                        console.log(`‚úÖ Loaded ${data.sentences.length} sentences from Firebase`);
                        return true;
                    }
                }
                
                console.log('‚ÑπÔ∏è Firebase connected but no data found');
                return false;
                
            } catch (error) {
                console.error(`‚ùå Firebase attempt ${attempt} failed:`, error.message);
                
                if (attempt === maxRetries) {
                    updateConnectionStatus(false);
                    return false;
                }
                
                // ƒê·ª£i tr∆∞·ªõc khi th·ª≠ l·∫°i
                await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
            }
        }
        
        return false;
    }

    // H√†m th·ª≠ k·∫øt n·ªëi l·∫°i Firebase
    async function retryFirebaseConnection() {
        console.log('üîÑ Retrying Firebase connection...');
        
        const success = await tryLoadFromFirebase(2);
        
        if (success) {
            showNotification('üîÑ ƒê√£ ƒë·ªìng b·ªô v·ªõi cloud', 'success');
        } else {
            // Th·ª≠ l·∫°i sau 30 gi√¢y
            setTimeout(retryFirebaseConnection, 30000);
        }
    }

    // Sync with Firebase - improved version
    async function syncWithFirebase() {
        const syncButton = document.querySelector('.sync-button');
        const originalContent = syncButton.innerHTML;

        syncButton.innerHTML = '<div class="loading">‚öôÔ∏è</div> ƒêang ƒë·ªìng b·ªô...';
        syncButton.disabled = true;

        const indicator = document.getElementById('status-indicator');
        indicator.className = 'status-indicator status-syncing';
        indicator.innerHTML = 'üü° ƒêang ƒë·ªìng b·ªô...';

        try {
            const sentences = getAllSentences();
            const timestamp = new Date();

            // Set timeout cho sync
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Sync timeout')), 10000)
            );
            
            const syncPromise = db.collection('sentences').doc('user_data').set({
                sentences: sentences,
                lastUpdated: timestamp,
                count: sentences.length
            });

            await Promise.race([syncPromise, timeoutPromise]);

            // Verify by loading back
            const success = await tryLoadFromFirebase(1);
            
            if (success) {
                updateConnectionStatus(true);
                showNotification('‚úÖ ƒê·ªìng b·ªô th√†nh c√¥ng!', 'success');
            } else {
                throw new Error('Sync verification failed');
            }

        } catch (error) {
            console.error('Sync error:', error);
            updateConnectionStatus(false);
            showNotification('‚ùå L·ªói ƒë·ªìng b·ªô: ' + error.message, 'error');
        } finally {
            syncButton.innerHTML = originalContent;
            syncButton.disabled = false;
        }
    }

    // Load data from Firebase - improved version
    async function loadFromFirebase() {
        try {
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Load timeout')), 8000)
            );
            
            const loadPromise = db.collection('sentences').doc('user_data').get();
            const doc = await Promise.race([loadPromise, timeoutPromise]);

            if (doc.exists) {
                const data = doc.data();
                if (data.sentences && Array.isArray(data.sentences)) {
                    loadSentencesToContainer(data.sentences);
                    showNotification(`üì• ƒê√£ t·∫£i ${data.sentences.length} c√¢u t·ª´ cloud`, 'info');
                    return true;
                }
            }
            return false;
        } catch (error) {
            console.error('Load from Firebase error:', error);
            showNotification('‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ cloud', 'error');
            return false;
        }
    }

    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            z-index: 1001;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        `;

        switch (type) {
            case 'success':
                notification.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';
                break;
            case 'error':
                notification.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
                break;
            case 'info':
                notification.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
                break;
        }

        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Import/Export Functions
    function showImportModal() {
        document.getElementById('import-modal').style.display = 'block';
    }

    function closeImportModal() {
        document.getElementById('import-modal').style.display = 'none';
        document.getElementById('json-input').value = '';
    }

    function loadJSONFile(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('json-input').value = e.target.result;
            };
            reader.readAsText(file);
        }
    }

    function importFromJSON() {
        const jsonInput = document.getElementById('json-input').value.trim();

        if (!jsonInput) {
            showNotification('‚ùå Vui l√≤ng nh·∫≠p n·ªôi dung JSON', 'error');
            return;
        }

        try {
            const sentences = JSON.parse(jsonInput);

            if (!Array.isArray(sentences)) {
                throw new Error('D·ªØ li·ªáu ph·∫£i l√† m·ªôt m·∫£ng c√°c c√¢u');
            }

            // Validate structure
            for (let i = 0; i < sentences.length; i++) {
                const sentence = sentences[i];
                if (!sentence.english || !sentence.vietnamese) {
                    throw new Error(`C√¢u th·ª© ${i + 1} thi·∫øu tr∆∞·ªùng 'english' ho·∫∑c 'vietnamese'`);
                }
            }

            // Confirm import
            const confirmImport = confirm(`B·∫°n c√≥ mu·ªën nh·∫≠p ${sentences.length} c√¢u kh√¥ng?\nD·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c thay th·∫ø.`);

            if (confirmImport) {
                loadSentencesToContainer(sentences);
                closeImportModal();
                showNotification(`‚úÖ ƒê√£ nh·∫≠p th√†nh c√¥ng ${sentences.length} c√¢u!`, 'success');

                // Auto save to localStorage
                saveToLocalStorage();
            }

        } catch (error) {
            showNotification('‚ùå L·ªói ƒë·ªãnh d·∫°ng JSON: ' + error.message, 'error');
        }
    }

    function exportToJSON() {
        const sentences = getAllSentences();

        if (sentences.length === 0) {
            showNotification('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
            return;
        }

        const dataStr = JSON.stringify(sentences, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `english_sentences_${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        showNotification(`üíæ ƒê√£ xu·∫•t ${sentences.length} c√¢u ra file JSON`, 'success');
    }

    function loadSentencesToContainer(sentences) {
        const container = document.getElementById('sentences-container');
        container.innerHTML = '';

        sentences.forEach(sentence => {
            const newCard = createSentenceCard(sentence.english, sentence.vietnamese);
            container.appendChild(newCard);
        });
    }

    function createSentenceCard(englishText = '', vietnameseText = '') {
        const newCard = document.createElement('div');
        newCard.className = 'sentence-card new-card';

        newCard.innerHTML = `
            <div class="english-line">
                <div class="english-text" contenteditable="true" data-placeholder="Nh·∫≠p c√¢u ti·∫øng Anh...">${englishText}</div>
                <button class="play-button" onclick="speakText(this)">
                    üîä
                </button>
            </div>
            <div class="vietnamese-text" contenteditable="true" data-placeholder="Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát...">${vietnameseText}</div>
           <button class="delete-button" onclick="deleteSentence(this)">
               üóëÔ∏è
           </button>
       `;

        // Setup placeholder handling
        handlePlaceholder(newCard.querySelector('.english-text'));
        handlePlaceholder(newCard.querySelector('.vietnamese-text'));

        return newCard;
    }

    // Text-to-Speech v·ªõi gi·ªçng ti·∫øng Anh B1
    function speakText(button) {
        const englishText = button.parentElement.querySelector('.english-text').textContent.trim();

        if (englishText && englishText !== 'Nh·∫≠p c√¢u ti·∫øng Anh...') {
            speakEnglishText(englishText, button);
        } else {
            showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p c√¢u ti·∫øng Anh tr∆∞·ªõc khi ph√°t √¢m!', 'error');
        }
    }

    function speakEnglishText(text, button = null) {
        const utterance = new SpeechSynthesisUtterance(text);

        // C√†i ƒë·∫∑t cho tr√¨nh ƒë·ªô B1
        utterance.lang = 'en-US';
        utterance.rate = 0.8; // T·ªëc ƒë·ªô ch·∫≠m h∆°n cho B1
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        // Th·ª≠ t√¨m gi·ªçng n√≥i ti·∫øng Anh ph√π h·ª£p
        const voices = speechSynthesis.getVoices();
        const englishVoice = voices.find(voice =>
            voice.lang.startsWith('en-') && voice.name.includes('Female')
        ) || voices.find(voice => voice.lang.startsWith('en-'));

        if (englishVoice) {
            utterance.voice = englishVoice;
        }

        // Hi·ªáu ·ª©ng n√∫t khi ƒëang ph√°t
        if (button) {
            button.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';

            utterance.onend = function () {
                button.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
            };
        }

        speechSynthesis.speak(utterance);
    }

    // Ch·∫ø ƒë·ªô luy·ªán t·∫≠p
    function showPracticeMode() {
        document.getElementById('practice-container').style.display = 'block';
        document.getElementById('test-container').style.display = 'none';
        document.getElementById('results-container').style.display = 'none';

        // C·∫≠p nh·∫≠t active button
        document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // Ch·∫ø ƒë·ªô ki·ªÉm tra
    function showTestMode() {
        const sentences = getAllSentences();
        if (sentences.length < 5) {
            showNotification('‚ùå C·∫ßn √≠t nh·∫•t 5 c√¢u ƒë·ªÉ b·∫Øt ƒë·∫ßu ki·ªÉm tra. Vui l√≤ng th√™m th√™m c√¢u!', 'error');
            return;
        }

        document.getElementById('practice-container').style.display = 'none';
        document.getElementById('test-container').style.display = 'block';
        document.getElementById('results-container').style.display = 'none';

        // C·∫≠p nh·∫≠t active button
        document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Chu·∫©n b·ªã b√†i ki·ªÉm tra
        prepareTest(sentences);
    }

    function getAllSentences() {
        const sentences = [];
        const cards = document.querySelectorAll('#sentences-container .sentence-card');

        cards.forEach(card => {
            const englishText = card.querySelector('.english-text').textContent.trim();
            const vietnameseText = card.querySelector('.vietnamese-text').textContent.trim();

            if (englishText && englishText !== 'Nh·∫≠p c√¢u ti·∫øng Anh...' &&
                vietnameseText && vietnameseText !== 'Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát...') {
                sentences.push({
                    english: englishText,
                    vietnamese: vietnameseText
                });
            }
        });

        return sentences;
    }

    function prepareTest(sentences) {
        // L·∫•y ng·∫´u nhi√™n t·ªëi ƒëa 20 c√¢u
        const shuffled = [...sentences].sort(() => 0.5 - Math.random());
        testQuestions = shuffled.slice(0, Math.min(20, sentences.length));

        // Reset test state
        currentQuestionIndex = 0;
        userAnswers = new Array(testQuestions.length).fill('');

        // C·∫≠p nh·∫≠t UI
        document.getElementById('total-questions').textContent = testQuestions.length;
        updateTestQuestion();
    }

    function updateTestQuestion() {
        const question = testQuestions[currentQuestionIndex];

        document.getElementById('current-question').textContent = currentQuestionIndex + 1;
        document.getElementById('question-number').textContent = currentQuestionIndex + 1;
        document.getElementById('answer-input').value = userAnswers[currentQuestionIndex];

        // C·∫≠p nh·∫≠t progress bar
        const progress = ((currentQuestionIndex + 1) / testQuestions.length) * 100;
        document.getElementById('progress-fill').style.width = progress + '%';

        // C·∫≠p nh·∫≠t navigation buttons
        document.getElementById('prev-button').disabled = currentQuestionIndex === 0;
        document.getElementById('next-button').style.display =
            currentQuestionIndex === testQuestions.length - 1 ? 'none' : 'block';
        document.getElementById('submit-button').style.display =
            currentQuestionIndex === testQuestions.length - 1 ? 'block' : 'none';
    }

    function playTestAudio() {
        const question = testQuestions[currentQuestionIndex];
        const button = document.querySelector('.test-play-button');
        speakEnglishText(question.english, button);
    }

    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            // L∆∞u c√¢u tr·∫£ l·ªùi hi·ªán t·∫°i
            userAnswers[currentQuestionIndex] = document.getElementById('answer-input').value;
            currentQuestionIndex--;
            updateTestQuestion();
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < testQuestions.length - 1) {
            // L∆∞u c√¢u tr·∫£ l·ªùi hi·ªán t·∫°i
            userAnswers[currentQuestionIndex] = document.getElementById('answer-input').value;
            currentQuestionIndex++;
            updateTestQuestion();
        }
    }

    function submitTest() {
        // L∆∞u c√¢u tr·∫£ l·ªùi cu·ªëi c√πng
        userAnswers[currentQuestionIndex] = document.getElementById('answer-input').value;

        // T√≠nh ƒëi·ªÉm v√† hi·ªÉn th·ªã k·∫øt qu·∫£
        calculateAndShowResults();
    }

    function calculateAndShowResults() {
        let totalSimilarity = 0;
        const results = [];

        for (let i = 0; i < testQuestions.length; i++) {
            const question = testQuestions[i];
            const userAnswer = userAnswers[i].trim().toLowerCase();
            const correctAnswer = question.english.toLowerCase();

            // T√≠nh ƒë·ªô ch√≠nh x√°c
            const similarity = calculateSimilarity(userAnswer, correctAnswer);
            totalSimilarity += similarity;

            // M·ªôt c√¢u ƒë∆∞·ª£c coi l√† ƒë√∫ng n·∫øu >= 80% ch√≠nh x√°c
            const isCorrect = similarity >= 0.8;

            results.push({
                question: question,
                userAnswer: userAnswers[i],
                isCorrect: isCorrect,
                similarity: similarity
            });
        }

        // T√≠nh ƒëi·ªÉm trung b√¨nh t·ª´ t·ªïng % ch√≠nh x√°c
        const averageScore = totalSimilarity / testQuestions.length;

        showResults(averageScore, results);
    }

    function calculateSimilarity(str1, str2) {
        const normalized1 = normalizeText(str1);
        const normalized2 = normalizeText(str2);

        // N·∫øu gi·ªëng h·ªát nhau
        if (normalized1 === normalized2) return 1;

        // T√≠nh similarity b·∫±ng c√°ch so s√°nh t·ª´ng t·ª´
        const words1 = normalized1.split(' ');
        const words2 = normalized2.split(' ');

        let correctWords = 0;
        const maxWords = Math.max(words1.length, words2.length);

        // ƒê·∫øm s·ªë t·ª´ gi·ªëng nhau (kh√¥ng c·∫ßn th·ª© t·ª±)
        const words2Copy = [...words2];
        for (let word of words1) {
            const index = words2Copy.indexOf(word);
            if (index !== -1) {
                correctWords++;
                words2Copy.splice(index, 1);
            }
        }

        return correctWords / maxWords;
    }

    function normalizeText(text) {
        return text.toLowerCase()
            .replace(/[^\w\s]/g, '') // Lo·∫°i b·ªè d·∫•u c√¢u
            .replace(/\s+/g, ' ')    // Chu·∫©n h√≥a kho·∫£ng tr·∫Øng
            .trim();
    }

    function showResults(averageScore, results) {
        document.getElementById('test-container').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';

        // Hi·ªÉn th·ªã ƒëi·ªÉm s·ªë trung b√¨nh
        updateScoreDisplay(averageScore, results);

        // T·∫°o chi ti·∫øt k·∫øt qu·∫£
        const resultsDetails = document.getElementById('results-details');
        resultsDetails.innerHTML = '';

        results.forEach((result, index) => {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result-item ${result.isCorrect ? 'result-correct' : 'result-incorrect'}`;

            const similarityPercent = Math.round(result.similarity * 100);

            resultDiv.innerHTML = `
        <div class="result-question">C√¢u ${index + 1}: ${result.question.vietnamese}</div>
        <div class="result-answer">
            <strong>B·∫°n vi·∫øt:</strong> 
            <span class="user-answer">${result.userAnswer || '(Kh√¥ng tr·∫£ l·ªùi)'}</span>
            ${result.userAnswer ? `<small style="color: #7f8c8d;"> (${similarityPercent}% ch√≠nh x√°c)</small>` : ''}
        </div>
        <div class="result-answer">
            <strong>ƒê√°p √°n:</strong> 
            <span class="correct-answer">${result.question.english}</span>
        </div>
        <div style="margin-top: 10px;">
            <button class="play-button" onclick="speakEnglishText('${result.question.english.replace(/'/g, "\\'")}', this)" style="width: 35px; height: 35px; font-size: 12px;">
                üîä
            </button>
        </div>
    `;

            resultsDetails.appendChild(resultDiv);
        });
    }

    function getScoreColor(percentage) {
        if (percentage >= 90) return '#27ae60';  // Xanh l√°
        if (percentage >= 80) return '#f39c12';  // Cam
        if (percentage >= 70) return '#e67e22';  // Cam ƒë·∫≠m
        return '#e74c3c';  // ƒê·ªè
    }

    function updateScoreDisplay(averageScore, results) {
        const percentage = averageScore * 100;
        const scoreElement = document.getElementById('score-display');

        // Hi·ªÉn th·ªã ƒëi·ªÉm trung b√¨nh
        scoreElement.textContent = `${Math.round(percentage)}%`;
        scoreElement.style.color = getScoreColor(percentage);

        // ƒê·∫øm s·ªë c√¢u ƒë√∫ng (>= 80%) ƒë·ªÉ hi·ªÉn th·ªã th√™m
        const correctCount = results.filter(r => r.isCorrect).length;

        // Th√™m text m√¥ t·∫£
        const scoreText = document.querySelector('.score-text');
        let description = '';

        if (percentage >= 90) description = 'Xu·∫•t s·∫Øc! üéâ';
        else if (percentage >= 80) description = 'T·ªët! üëç';
        else if (percentage >= 70) description = 'Kh√°! üëå';
        else if (percentage >= 60) description = 'Trung b√¨nh üòê';
        else description = 'C·∫ßn c·ªë g·∫Øng th√™m! üí™';

        scoreText.innerHTML = `ƒêi·ªÉm trung b√¨nh: ${Math.round(percentage)}%<br>
                      <small>C√¢u ƒë√∫ng: ${correctCount}/${results.length} - ${description}</small>`;
    }

    function retakeTest() {
        showTestMode();
    }

    // Th√™m c√¢u m·ªõi
    function addNewSentence() {
        const container = document.getElementById('sentences-container');
        const newCard = createSentenceCard();

        container.appendChild(newCard);

        // Cu·ªôn ƒë·∫øn th·∫ª m·ªõi v√† focus v√†o √¥ ti·∫øng Anh
        setTimeout(() => {
            newCard.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            const englishInput = newCard.querySelector('.english-text');
            englishInput.focus();
        }, 100);
    }

    // X√≥a c√¢u
    function deleteSentence(button) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u n√†y kh√¥ng?')) {
            const card = button.parentElement;
            card.style.animation = 'slideOut 0.3s ease';

            setTimeout(() => {
                card.remove();
                scheduleAutoSave(); // Auto save after delete
            }, 300);
        }
    }

    // X·ª≠ l√Ω placeholder cho c√°c √¥ nh·∫≠p li·ªáu
    function handlePlaceholder(element) {
        const placeholder = element.getAttribute('data-placeholder');

        element.addEventListener('focus', function () {
            if (this.textContent.trim() === '' || this.textContent === placeholder) {
                this.textContent = '';
                this.style.color = '#2c3e50';
            }
        });

        element.addEventListener('blur', function () {
            if (this.textContent.trim() === '') {
                this.textContent = '';
                this.style.color = '#bdc3c7';
            }
        });

        // Hi·ªÉn th·ªã placeholder ban ƒë·∫ßu
        if (element.textContent.trim() === '') {
            element.style.color = '#bdc3c7';
        }
    }

    // Local Storage functions
    function saveToLocalStorage() {
        const sentences = getAllSentences();
        localStorage.setItem('englishLearningData', JSON.stringify(sentences));
    }

    function loadFromLocalStorage() {
        const savedData = localStorage.getItem('englishLearningData');
        if (savedData) {
            try {
                const sentences = JSON.parse(savedData);
                if (Array.isArray(sentences) && sentences.length > 0) {
                    loadSentencesToContainer(sentences);
                    return true;
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }
        return false;
    }

    // Th√™m auto-save v·ªõi debounce
    let autoSaveTimeout;
    function scheduleAutoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            saveToLocalStorage();
            
            // N·∫øu ƒë√£ k·∫øt n·ªëi Firebase, t·ª± ƒë·ªông sync
            if (firebaseConnected && getAllSentences().length > 0) {
                syncWithFirebase();
            }
        }, 2000);
    }

    // Th√™m c√¢u m·∫´u ƒë·ªÉ demo
    function addSampleSentences() {
        const sampleSentences = [
            {
                english: "Hello, how are you today?",
                vietnamese: "Xin ch√†o, h√¥m nay b·∫°n th·∫ø n√†o?"
            },
            {
                english: "What time is it now?",
                vietnamese: "B√¢y gi·ªù l√† m·∫•y gi·ªù?"
            },
            {
                english: "I love reading books in my free time.",
                vietnamese: "T√¥i th√≠ch ƒë·ªçc s√°ch trong th·ªùi gian r·∫£nh."
            },
            {
                english: "The weather is beautiful today.",
                vietnamese: "Th·ªùi ti·∫øt h√¥m nay th·∫≠t ƒë·∫πp."
            },
            {
                english: "Can you help me with this problem?",
                vietnamese: "B·∫°n c√≥ th·ªÉ gi√∫p t√¥i gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y kh√¥ng?"
            }
        ];

        loadSentencesToContainer(sampleSentences);
    }

    // H√†m kh·ªüi t·∫°o app - improved version
    async function initializeApp() {
        console.log('üöÄ Initializing app...');
        
        // Load voices khi trang web ƒë∆∞·ª£c t·∫£i
        speechSynthesis.getVoices();
        
        // ƒê·∫£m b·∫£o voices ƒë∆∞·ª£c load (m·ªôt s·ªë browser c·∫ßn th·ªùi gian)
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                speechSynthesis.getVoices();
            };
        }

        // Th·ª≠ t·∫£i t·ª´ Firebase tr∆∞·ªõc
        console.log('‚è≥ Trying to load from Firebase...');
        const firebaseLoadSuccess = await tryLoadFromFirebase();
        
        if (firebaseLoadSuccess) {
            console.log('‚úÖ Loaded from Firebase successfully');
            showNotification('üì• ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ cloud', 'success');
        } else {
            console.log('‚ùå Failed to load from Firebase, trying localStorage...');
            
            // N·∫øu Firebase th·∫•t b·∫°i, th·ª≠ localStorage
            const localStorageLoadSuccess = loadFromLocalStorage();
            
            if (localStorageLoadSuccess) {
                console.log('‚úÖ Loaded from localStorage');
                showNotification('üì± ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ m√°y', 'info');
                
                // Th·ª≠ sync v·ªõi Firebase sau khi load t·ª´ localStorage
                setTimeout(retryFirebaseConnection, 3000);
            } else {
                console.log('‚ÑπÔ∏è No saved data found, loading sample sentences');
                addSampleSentences();
                showNotification('üéØ ƒê√£ t·∫£i d·ªØ li·ªáu m·∫´u', 'info');
            }
        }
    }

    // Event Listeners
    document.addEventListener('keydown', function (e) {
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();

            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                document.execCommand('bold');
            }
        }

        // Enter ƒë·ªÉ chuy·ªÉn c√¢u ti·∫øp theo trong test
        if (e.key === 'Enter' && document.getElementById('test-container').style.display === 'block') {
            e.preventDefault();
            if (currentQuestionIndex < testQuestions.length - 1) {
                nextQuestion();
            } else {
                submitTest();
            }
        }

        // Keyboard shortcuts
        if (e.ctrlKey && e.key === 't') {
            e.preventDefault();
            showTestMode();
        }

        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            showPracticeMode();
        }

        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            if (document.getElementById('practice-container').style.display !== 'none') {
                addNewSentence();
            }
        }

        // Import/Export shortcuts
        if (e.ctrlKey && e.key === 'i') {
            e.preventDefault();
            showImportModal();
        }

        if (e.ctrlKey && e.key === 'e') {
            e.preventDefault();
            exportToJSON();
        }

        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            syncWithFirebase();
        }
    });

    // Auto-save khi ng∆∞·ªùi d√πng nh·∫≠p li·ªáu - improved version
    document.addEventListener('input', function (e) {
        if (e.target.contentEditable === 'true') {
            scheduleAutoSave();
        }
    });

    // X·ª≠ l√Ω paste text
    document.addEventListener('paste', function (e) {
        const target = e.target;
        if (target.contentEditable === 'true') {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            document.execCommand('insertText', false, text);
        }
    });

    // Close modal when clicking outside
    document.addEventListener('click', function (e) {
        const modal = document.getElementById('import-modal');
        if (e.target === modal) {
            closeImportModal();
        }
    });

    // Network status listeners
    window.addEventListener('online', function() {
        console.log('üåê Network back online, retrying Firebase...');
        retryFirebaseConnection();
    });

    window.addEventListener('offline', function() {
        console.log('üìµ Network offline');
        updateConnectionStatus(false);
    });

    // CSS cho animation slideOut
    const style = document.createElement('style');
    style.textContent = `
       @keyframes slideOut {
           from {
               opacity: 1;
               transform: translateX(0);
           }
           to {
               opacity: 0;
               transform: translateX(-100%);
           }
       }
   `;
    document.head.appendChild(style);

    // Kh·ªüi t·∫°o khi trang web ƒë∆∞·ª£c t·∫£i - improved version
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Visibility change listener - t·ª± ƒë·ªông sync khi user quay l·∫°i tab
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && firebaseConnected) {
            // N·∫øu user quay l·∫°i tab v√† Firebase ƒë√£ k·∫øt n·ªëi, th·ª≠ t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t
            setTimeout(() => {
                tryLoadFromFirebase(1);
            }, 1000);
        }
    });

    // Before unload - save data before user leaves
    window.addEventListener('beforeunload', function(e) {
        // L∆∞u v√†o localStorage tr∆∞·ªõc khi r·ªùi kh·ªèi trang
        saveToLocalStorage();
        
        // N·∫øu c√≥ d·ªØ li·ªáu m·ªõi v√† Firebase connected, th·ª≠ sync nhanh
        if (firebaseConnected && getAllSentences().length > 0) {
            // Quick sync without waiting
            const sentences = getAllSentences();
            const timestamp = new Date();
            
            db.collection('sentences').doc('user_data').set({
                sentences: sentences,
                lastUpdated: timestamp,
                count: sentences.length
            }).catch(console.error);
        }
    });

    // Service Worker registration ƒë·ªÉ cache app cho offline usage
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            // T·∫°o m·ªôt service worker ƒë∆°n gi·∫£n
            const swCode = `
                const CACHE_NAME = 'english-learning-v1';
                const urlsToCache = [
                    '/',
                    '/style.css',
                    '/script.js'
                ];

                self.addEventListener('install', function(event) {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(function(cache) {
                                return cache.addAll(urlsToCache);
                            })
                    );
                });

                self.addEventListener('fetch', function(event) {
                    event.respondWith(
                        caches.match(event.request)
                            .then(function(response) {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            }
                        )
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(function(registration) {
                    console.log('‚úÖ Service Worker registered successfully');
                })
                .catch(function(error) {
                    console.log('‚ùå Service Worker registration failed:', error);
                });
        });
    }

    // Performance optimization - lazy loading cho large datasets
    function optimizePerformance() {
        // N·∫øu c√≥ qu√° nhi·ªÅu c√¢u (>100), ch·ªâ hi·ªÉn th·ªã 50 c√¢u ƒë·∫ßu
        const allCards = document.querySelectorAll('#sentences-container .sentence-card');
        if (allCards.length > 100) {
            allCards.forEach((card, index) => {
                if (index >= 50) {
                    card.style.display = 'none';
                }
            });
            
            // Th√™m n√∫t "Load more"
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.className = 'add-button';
            loadMoreBtn.innerHTML = 'üìÑ Hi·ªÉn th·ªã th√™m c√¢u';
            loadMoreBtn.onclick = function() {
                const hiddenCards = document.querySelectorAll('#sentences-container .sentence-card[style*="display: none"]');
                for (let i = 0; i < Math.min(25, hiddenCards.length); i++) {
                    hiddenCards[i].style.display = 'block';
                }
                
                if (hiddenCards.length <= 25) {
                    loadMoreBtn.remove();
                }
            };
            
            document.getElementById('sentences-container').appendChild(loadMoreBtn);
        }
    }

    // Error handling v√† logging
    window.addEventListener('error', function(e) {
        console.error('‚ùå JavaScript Error:', e.error);
        showNotification('‚ö†Ô∏è ƒê√£ x·∫£y ra l·ªói, vui l√≤ng t·∫£i l·∫°i trang', 'error');
    });

    window.addEventListener('unhandledrejection', function(e) {
        console.error('‚ùå Unhandled Promise Rejection:', e.reason);
        // Kh√¥ng hi·ªÉn th·ªã notification cho promise rejection ƒë·ªÉ tr√°nh spam
    });

    // Health check function
    function performHealthCheck() {
        const healthStatus = {
            localStorage: false,
            firebase: firebaseConnected,
            speechSynthesis: 'speechSynthesis' in window,
            dataIntegrity: false
        };

        // Check localStorage
        try {
            localStorage.setItem('health-check', 'test');
            localStorage.removeItem('health-check');
            healthStatus.localStorage = true;
        } catch (e) {
            healthStatus.localStorage = false;
        }

        // Check data integrity
        const sentences = getAllSentences();
        healthStatus.dataIntegrity = sentences.length > 0;

        console.log('üè• Health Check:', healthStatus);
        
        return healthStatus;
    }

    // Ch·∫°y health check m·ªói 5 ph√∫t
    setInterval(performHealthCheck, 5 * 60 * 1000);
    
</script>

   
</body>

</html>