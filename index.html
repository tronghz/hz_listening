<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Listening Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab.active {
            background: white;
            color: var(--primary);
            font-weight: 600;
            transform: scale(1.02);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }

        .content {
            background: white;
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            min-height: 600px;
            backdrop-filter: blur(20px);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Practice Section */
        .section-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .add-card-form {
            background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--gray-200);
        }

        .add-card-form h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error), #dc2626);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-play {
            background: linear-gradient(135deg, var(--success), #059669);
            padding: 10px 16px;
            font-size: 14px;
        }

        .cards-container {
            margin-top: 30px;
        }

        .cards-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cards-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .card-count {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .card {
            background: white;
            border: 2px solid var(--gray-100);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.15);
        }

        .card:hover::before {
            transform: scaleY(1);
        }

        .card-content {
            flex: 1;
        }

        .card-english {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        .card-vietnamese {
            font-size: 1rem;
            color: var(--gray-600);
            font-style: italic;
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Test Section */
        .test-container {
            text-align: center;
        }

        .test-info {
            background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid #81d4fa;
        }

        .test-info h3 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 15px;
        }

        .test-info p {
            font-size: 1.1rem;
            color: var(--gray-600);
            margin-bottom: 10px;
        }

        .question-container {
            background: linear-gradient(135deg, var(--gray-50), white);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid var(--gray-100);
        }

        .question-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
        }

        .play-button {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 20px 40px;
            border: none;
            border-radius: 60px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 15px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .play-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.3);
        }

        .answer-input {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            font-size: 1.1rem;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .result-container {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 2px solid #86efac;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
        }

        .result-item {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .correct {
            border-left: 6px solid var(--success);
        }

        .incorrect {
            border-left: 6px solid var(--error);
        }

        .score {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray-500);
            font-size: 1.1rem;
        }

        .stats-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: linear-gradient(135deg, white, var(--gray-50));
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid var(--gray-100);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .content {
                padding: 25px;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .card {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .card-actions {
                justify-content: center;
            }
        }

        /* Animation for new cards */
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-new {
            animation: slideInDown 0.5s ease-out;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-headphones"></i> Luyện Listening Pro</h1>
            <p>Nâng cao kỹ năng nghe tiếng Anh với công nghệ AI hiện đại</p>
        </div>

        <div class="tab-container">
            <button class="tab active" onclick="showTab('practice')">
                <i class="fas fa-book-open"></i> Luyện Tập
            </button>
            <button class="tab" onclick="showTab('test')">
                <i class="fas fa-clipboard-check"></i> Kiểm Tra
            </button>
        </div>

        <div class="content">
            <!-- Practice Section -->
            <div id="practice" class="section active">
                <h2 class="section-title">
                    <i class="fas fa-book-open"></i> Luyện Tập
                </h2>

                <div class="stats-card">
                    <div class="stat-item">
                        <span class="stat-number" id="totalCards">0</span>
                        <span class="stat-label">Tổng số thẻ</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="todayCards">0</span>
                        <span class="stat-label">Thẻ hôm nay</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="lastScore">0</span>
                        <span class="stat-label">Điểm gần nhất</span>
                    </div>
                </div>

                <div class="add-card-form">
                    <h3><i class="fas fa-plus-circle"></i> Thêm thẻ mới</h3>
                    <div class="form-group">
                        <label><i class="fas fa-globe-americas"></i> Tiếng Anh:</label>
                        <input type="text" id="englishInput" placeholder="Nhập câu tiếng Anh...">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-language"></i> Tiếng Việt:</label>
                        <input type="text" id="vietnameseInput" placeholder="Nhập nghĩa tiếng Việt...">
                    </div>
                    <button class="btn" onclick="addCard()">
                        <i class="fas fa-plus"></i> Thêm Thẻ
                    </button>
                </div>

                <div class="cards-container">
                    <div class="cards-header">
                        <h3>Danh sách thẻ</h3>
                        <div class="card-count" id="cardCount">0 thẻ</div>
                    </div>
                    <div id="cardsList">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Section -->
            <div id="test" class="section">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-check"></i> Kiểm Tra
                </h2>

                <div id="testStart" class="test-container">
                    <!-- Thêm vào phần test-info -->
                    <div class="test-info">
                        <h3><i class="fas fa-target"></i> Bài kiểm tra nghe</h3>
                        <p>Bạn sẽ nghe 10 câu tiếng Anh ngẫu nhiên với <strong>nhiều giọng nói khác nhau</strong> (nam,
                            nữ, trẻ, già, nhanh, chậm) và nhập lại những gì bạn nghe được.</p>
                        
                        <p><strong>Lưu ý:</strong> Mỗi câu sẽ được đọc bởi một người khác nhau với phong cách khác nhau để
                            mô phỏng thực tế.</p>
                        <div id="voiceInfo"
                            style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px; font-size: 0.9rem;">
                            <i class="fas fa-microphone"></i> <span id="voiceCount">Đang tải giọng nói...</span>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="startTest()" id="startTestBtn">
                        <i class="fas fa-play"></i> Bắt Đầu Kiểm Tra
                    </button>
                </div>

                <div id="testQuestion" class="test-container" style="display: none;">
                    <div class="question-container">
                        <div class="question-number" id="questionNumber">Câu 1/10</div>
                        <button class="play-button" onclick="playCurrentQuestion()">
                            <i class="fas fa-volume-up"></i> Phát Âm
                        </button>
                        <input type="text" class="answer-input" id="answerInput"
                            placeholder="Nhập những gì bạn nghe được...">
                        <div>
                            <button class="btn" onclick="nextQuestion()">
                                <i class="fas fa-arrow-right"></i> Câu Tiếp Theo
                            </button>
                        </div>
                    </div>
                </div>

                <div id="testResult" class="test-container" style="display: none;">
                    <h3><i class="fas fa-trophy"></i> Kết Quả Kiểm Tra</h3>
                    <div class="score" id="finalScore"></div>
                    <div id="resultDetails"></div>
                    <button class="btn" onclick="resetTest()">
                        <i class="fas fa-redo"></i> Làm Lại
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBrJh1921kNKJq6EF0U76pBD_VaGChgQqk",
            authDomain: "hz-listening.firebaseapp.com",
            projectId: "hz-listening",
            storageBucket: "hz-listening.firebasestorage.app",
            messagingSenderId: "1044959632237",
            appId: "1:1044959632237:web:d2fcc1294a83ca5349d864",
            measurementId: "G-SEY2ERMPDW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let cards = [];
        let currentTest = {
            questions: [],
            currentIndex: 0,
            answers: [],
            isActive: false
        };

        // Make functions globally available
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.cards = cards;
        window.currentTest = currentTest;

        // Load cards on page load
        loadCards();

        // Real-time listener for cards
        const unsubscribe = onSnapshot(collection(db, "cards"), (snapshot) => {
            cards.length = 0;
            snapshot.forEach((doc) => {
                cards.push({ id: doc.id, ...doc.data() });
            });
            displayCards();
            updateStats();
        });

        async function loadCards() {
            try {
                const querySnapshot = await getDocs(collection(db, "cards"));
                cards.length = 0;
                querySnapshot.forEach((doc) => {
                    cards.push({ id: doc.id, ...doc.data() });
                });
                displayCards();
                updateStats();
            } catch (error) {
                console.error("Error loading cards:", error);
                document.getElementById('cardsList').innerHTML = '<div class="loading"><i class="fas fa-exclamation-triangle"></i> Lỗi khi tải dữ liệu</div>';
            }
        }

        window.loadCards = loadCards;
    </script>

    <script>
        // Available voices for random selection
        const voiceConfigs = [
            { lang: 'en-US', rate: 0.8, pitch: 1.0 },
            { lang: 'en-GB', rate: 0.9, pitch: 1.1 },
            { lang: 'en-AU', rate: 0.7, pitch: 0.9 },
            { lang: 'en-CA', rate: 0.85, pitch: 1.0 },
            { lang: 'en-IN', rate: 0.75, pitch: 1.2 },
            { lang: 'en-ZA', rate: 0.8, pitch: 0.95 },
            { lang: 'en-NZ', rate: 0.9, pitch: 1.05 }
        ];

        // Tab switching with animation
        function showTab(tabName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Update statistics
        function updateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayCards = window.cards.filter(card => {
                const cardDate = card.createdAt?.toDate ? card.createdAt.toDate() : new Date(card.createdAt || 0);
                cardDate.setHours(0, 0, 0, 0);
                return cardDate.getTime() === today.getTime();
            }).length;

            document.getElementById('totalCards').textContent = window.cards.length;
            document.getElementById('todayCards').textContent = todayCards;

            const lastScore = localStorage.getItem('lastTestScore') || '0';
            document.getElementById('lastScore').textContent = lastScore;
        }

        // Add new card with animation
        async function addCard() {
            const english = document.getElementById('englishInput').value.trim();
            const vietnamese = document.getElementById('vietnameseInput').value.trim();

            if (!english || !vietnamese) {
                alert('Vui lòng nhập đầy đủ nội dung tiếng Anh và tiếng Việt!');
                return;
            }

            try {
                await window.addDoc(window.collection(window.db, "cards"), {
                    english: english,
                    vietnamese: vietnamese,
                    createdAt: new Date()
                });

                // Clear inputs
                document.getElementById('englishInput').value = '';
                document.getElementById('vietnameseInput').value = '';

                // Show success message
                showNotification('Thẻ đã được thêm thành công!', 'success');

                console.log('Card added successfully');
            } catch (error) {
                console.error("Error adding card:", error);
                showNotification('Lỗi khi thêm thẻ: ' + error.message, 'error');
            }
        }

        // Delete card with confirmation
        async function deleteCard(cardId) {
            if (confirm('Bạn có chắc chắn muốn xóa thẻ này?')) {
                try {
                    await window.deleteDoc(window.doc(window.db, "cards", cardId));
                    showNotification('Thẻ đã được xóa thành công!', 'success');
                    console.log('Card deleted successfully');
                } catch (error) {
                    console.error("Error deleting card:", error);
                    showNotification('Lỗi khi xóa thẻ: ' + error.message, 'error');
                }
            }
        }

        // Display cards with improved UI
        function displayCards() {
            const cardsList = document.getElementById('cardsList');
            const cardCount = document.getElementById('cardCount');

            cardCount.textContent = `${window.cards.length} thẻ`;

            if (window.cards.length === 0) {
                cardsList.innerHTML = '<div class="loading"><i class="fas fa-inbox"></i> Chưa có thẻ nào. Hãy thêm thẻ đầu tiên!</div>';
                return;
            }

            // Sort cards by creation time (newest first)
            const sortedCards = [...window.cards].sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                return dateB - dateA;
            });

            cardsList.innerHTML = sortedCards.map((card, index) => `
                <div class="card ${index === 0 ? 'card-new' : ''}">
                    <div class="card-content">
                        <div class="card-english">${escapeHtml(card.english)}</div>
                        <div class="card-vietnamese">${escapeHtml(card.vietnamese)}</div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-play" onclick="speakText('${escapeForJs(card.english)}')">
                            <i class="fas fa-volume-up"></i> Phát âm
                        </button>
                        <button class="btn btn-danger" onclick="deleteCard('${card.id}')">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Escape HTML for security
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Escape for JavaScript
        function escapeForJs(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // Enhanced text to speech with random voices
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                speechSynthesis.cancel();

                // Wait for voices to be loaded
                const speakWithVoices = () => {
                    const voices = speechSynthesis.getVoices();

                    if (voices.length === 0) {
                        // Fallback if no voices loaded yet
                        setTimeout(speakWithVoices, 100);
                        return;
                    }

                    // Filter English voices and categorize them
                    const englishVoices = voices.filter(voice =>
                        voice.lang.startsWith('en-') &&
                        voice.name.length > 0
                    );

                    // Try to categorize voices by characteristics
                    const voiceCategories = {
                        female: englishVoices.filter(voice =>
                            voice.name.toLowerCase().includes('female') ||
                            voice.name.toLowerCase().includes('woman') ||
                            voice.name.toLowerCase().includes('alice') ||
                            voice.name.toLowerCase().includes('allison') ||
                            voice.name.toLowerCase().includes('ava') ||
                            voice.name.toLowerCase().includes('emma') ||
                            voice.name.toLowerCase().includes('fiona') ||
                            voice.name.toLowerCase().includes('karen') ||
                            voice.name.toLowerCase().includes('moira') ||
                            voice.name.toLowerCase().includes('samantha') ||
                            voice.name.toLowerCase().includes('sarah') ||
                            voice.name.toLowerCase().includes('susan') ||
                            voice.name.toLowerCase().includes('tessa') ||
                            voice.name.toLowerCase().includes('veena') ||
                            voice.name.toLowerCase().includes('victoria') ||
                            voice.name.toLowerCase().includes('zoe') ||
                            voice.name.toLowerCase().includes('hazel')
                        ),
                        male: englishVoices.filter(voice =>
                            voice.name.toLowerCase().includes('male') ||
                            voice.name.toLowerCase().includes('man') ||
                            voice.name.toLowerCase().includes('alex') ||
                            voice.name.toLowerCase().includes('arthur') ||
                            voice.name.toLowerCase().includes('daniel') ||
                            voice.name.toLowerCase().includes('david') ||
                            voice.name.toLowerCase().includes('fred') ||
                            voice.name.toLowerCase().includes('george') ||
                            voice.name.toLowerCase().includes('james') ||
                            voice.name.toLowerCase().includes('john') ||
                            voice.name.toLowerCase().includes('lee') ||
                            voice.name.toLowerCase().includes('marcus') ||
                            voice.name.toLowerCase().includes('nathan') ||
                            voice.name.toLowerCase().includes('oliver') ||
                            voice.name.toLowerCase().includes('ralph') ||
                            voice.name.toLowerCase().includes('ryan') ||
                            voice.name.toLowerCase().includes('thomas') ||
                            voice.name.toLowerCase().includes('tom')
                        )
                    };

                    // If we don't have categorized voices, use all English voices
                    const availableVoices = [
                        ...voiceCategories.female,
                        ...voiceCategories.male,
                        ...englishVoices
                    ].filter((voice, index, self) =>
                        self.findIndex(v => v.name === voice.name) === index
                    );

                    // Voice configurations with variety
                    const voiceConfigs = [
                        // Young female voices
                        {
                            type: 'young_female',
                            rate: 0.9 + Math.random() * 0.2,
                            pitch: 1.2 + Math.random() * 0.3,
                            volume: 0.9 + Math.random() * 0.1
                        },
                        // Mature female voices  
                        {
                            type: 'mature_female',
                            rate: 0.8 + Math.random() * 0.2,
                            pitch: 1.0 + Math.random() * 0.2,
                            volume: 0.9 + Math.random() * 0.1
                        },
                        // Young male voices
                        {
                            type: 'young_male',
                            rate: 0.85 + Math.random() * 0.25,
                            pitch: 0.8 + Math.random() * 0.3,
                            volume: 0.9 + Math.random() * 0.1
                        },
                        // Mature male voices
                        {
                            type: 'mature_male',
                            rate: 0.75 + Math.random() * 0.2,
                            pitch: 0.7 + Math.random() * 0.2,
                            volume: 0.9 + Math.random() * 0.1
                        },
                        // Elderly voices (slower, more deliberate)
                        {
                            type: 'elderly',
                            rate: 0.6 + Math.random() * 0.2,
                            pitch: 0.8 + Math.random() * 0.4,
                            volume: 0.8 + Math.random() * 0.1
                        },
                        // Energetic voices (faster, higher energy)
                        {
                            type: 'energetic',
                            rate: 1.0 + Math.random() * 0.3,
                            pitch: 1.1 + Math.random() * 0.3,
                            volume: 1.0
                        },
                        // Calm/soft voices
                        {
                            type: 'calm',
                            rate: 0.7 + Math.random() * 0.2,
                            pitch: 0.9 + Math.random() * 0.3,
                            volume: 0.8 + Math.random() * 0.1
                        }
                    ];

                    // Select random configuration
                    const randomConfig = voiceConfigs[Math.floor(Math.random() * voiceConfigs.length)];

                    const utterance = new SpeechSynthesisUtterance(text);

                    // Select appropriate voice based on type
                    let selectedVoice;

                    if (randomConfig.type.includes('female') && voiceCategories.female.length > 0) {
                        selectedVoice = voiceCategories.female[Math.floor(Math.random() * voiceCategories.female.length)];
                    } else if (randomConfig.type.includes('male') && voiceCategories.male.length > 0) {
                        selectedVoice = voiceCategories.male[Math.floor(Math.random() * voiceCategories.male.length)];
                    } else if (availableVoices.length > 0) {
                        selectedVoice = availableVoices[Math.floor(Math.random() * availableVoices.length)];
                    }

                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        utterance.lang = selectedVoice.lang;

                        // Show voice info for debugging (remove in production)
                        console.log(`Using voice: ${selectedVoice.name} (${randomConfig.type})`);
                    }

                    // Apply voice characteristics
                    utterance.rate = Math.max(0.5, Math.min(2.0, randomConfig.rate));
                    utterance.pitch = Math.max(0.5, Math.min(2.0, randomConfig.pitch));
                    utterance.volume = Math.max(0.1, Math.min(1.0, randomConfig.volume));

                    // Add some personality through timing
                    utterance.addEventListener('start', () => {
                        console.log(`Speaking with ${randomConfig.type} voice characteristics`);
                    });

                    utterance.addEventListener('error', (e) => {
                        console.error('Speech synthesis error:', e);
                        showNotification('Lỗi phát âm. Vui lòng thử lại!', 'error');
                    });

                    speechSynthesis.speak(utterance);
                };

                speakWithVoices();

            } else {
                showNotification('Trình duyệt không hỗ trợ tính năng đọc văn bản!', 'error');
            }
        }

        function initializeVoices() {
            if ('speechSynthesis' in window) {
                // Load voices on page load
                const loadVoices = () => {
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        console.log('Available voices loaded:', voices.length);

                        // Log voice information for debugging
                        const englishVoices = voices.filter(voice => voice.lang.startsWith('en-'));
                        console.log('English voices available:', englishVoices.map(v => `${v.name} (${v.lang})`));

                        // Show voice variety notification
                        if (englishVoices.length > 5) {
                            showNotification(`Đã tải ${englishVoices.length} giọng nói tiếng Anh khác nhau!`, 'success');
                        }
                    } else {
                        // Retry loading voices
                        setTimeout(loadVoices, 100);
                    }
                };

                // Handle voices changed event
                speechSynthesis.addEventListener('voiceschanged', loadVoices);

                // Initial load attempt
                loadVoices();
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            // ... existing DOMContentLoaded code ...

            // Initialize voices
            initializeVoices();

            // Existing keyboard event listeners...
            document.getElementById('englishInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    document.getElementById('vietnameseInput').focus();
                }
            });

            document.getElementById('vietnameseInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    addCard();
                }
            });

            document.addEventListener('keypress', function (e) {
                const answerInput = document.getElementById('answerInput');
                if (e.key === 'Enter' && answerInput && document.activeElement === answerInput) {
                    nextQuestion();
                }
            });

            document.addEventListener('keydown', function (e) {
                if (e.code === 'Space' && window.currentTest.isActive &&
                    document.getElementById('testQuestion').style.display === 'block') {
                    e.preventDefault();
                    playCurrentQuestion();
                }
            });
        });


        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
               <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
               ${message}
           `;

            // Add notification styles
            notification.style.cssText = `
               position: fixed;
               top: 20px;
               right: 20px;
               padding: 15px 20px;
               border-radius: 10px;
               color: white;
               font-weight: 600;
               z-index: 1000;
               animation: slideInRight 0.3s ease-out;
               max-width: 300px;
               box-shadow: 0 4px 20px rgba(0,0,0,0.15);
           `;

            switch (type) {
                case 'success':
                    notification.style.background = 'linear-gradient(135deg, var(--success), #059669)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(135deg, var(--error), #dc2626)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-dark))';
            }

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Start test with improved UX
        function startTest() {
            if (window.cards.length < 10) {
                showNotification(`Bạn cần có ít nhất 10 thẻ để làm bài kiểm tra. Hiện tại bạn có ${window.cards.length} thẻ.`, 'error');
                return;
            }

            // Shuffle and select 10 random cards
            const shuffled = [...window.cards].sort(() => Math.random() - 0.5);
            window.currentTest.questions = shuffled.slice(0, 10);
            window.currentTest.currentIndex = 0;
            window.currentTest.answers = [];
            window.currentTest.isActive = true;

            // Show test interface
            document.getElementById('testStart').style.display = 'none';
            document.getElementById('testQuestion').style.display = 'block';
            document.getElementById('testResult').style.display = 'none';

            showCurrentQuestion();
            showNotification('Bài kiểm tra đã bắt đầu! Chúc bạn may mắn!', 'success');
        }

        // Show current question with progress
        function showCurrentQuestion() {
            const questionNumber = document.getElementById('questionNumber');
            const answerInput = document.getElementById('answerInput');

            questionNumber.innerHTML = `
               <i class="fas fa-question-circle"></i> 
               Câu ${window.currentTest.currentIndex + 1}/10
               <div style="width: 100%; background: var(--gray-200); border-radius: 10px; height: 8px; margin-top: 10px;">
                   <div style="width: ${(window.currentTest.currentIndex + 1) * 10}%; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 10px; height: 100%; transition: all 0.5s ease;"></div>
               </div>
           `;
            answerInput.value = '';
            answerInput.focus();

            // Auto-play the question after a short delay
            setTimeout(() => {
                playCurrentQuestion();
            }, 500);
        }

        // Play current question with random voice
        function playCurrentQuestion() {
            const currentQuestion = window.currentTest.questions[window.currentTest.currentIndex];
            speakText(currentQuestion.english);
        }

        // Next question with validation
        function nextQuestion() {
            const answerInput = document.getElementById('answerInput');
            const userAnswer = answerInput.value.trim();

            if (!userAnswer) {
                showNotification('Vui lòng nhập câu trả lời!', 'error');
                answerInput.focus();
                return;
            }

            // Save answer
            window.currentTest.answers.push({
                question: window.currentTest.questions[window.currentTest.currentIndex],
                userAnswer: userAnswer,
                correctAnswer: window.currentTest.questions[window.currentTest.currentIndex].english
            });

            window.currentTest.currentIndex++;

            if (window.currentTest.currentIndex < 10) {
                showCurrentQuestion();
            } else {
                showResults();
            }
        }

        // Enhanced similarity calculation
        function calculateSimilarity(str1, str2) {
            // Normalize strings
            const normalize = (str) => str.toLowerCase()
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, ' ')
                .trim();

            const s1 = normalize(str1);
            const s2 = normalize(str2);

            if (s1 === s2) return 100;

            const words1 = s1.split(' ');
            const words2 = s2.split(' ');

            // Calculate word-level similarity
            let matchCount = 0;
            const maxWords = Math.max(words1.length, words2.length);

            words1.forEach(word1 => {
                const bestMatch = words2.reduce((best, word2) => {
                    const similarity = getLevenshteinSimilarity(word1, word2);
                    return similarity > best ? similarity : best;
                }, 0);

                if (bestMatch > 0.7) { // 70% similarity threshold for individual words
                    matchCount += bestMatch;
                } else if (words2.includes(word1)) {
                    matchCount += 1;
                }
            });

            // Calculate character-level similarity as backup
            const charSimilarity = getLevenshteinSimilarity(s1, s2);

            // Use the better of word-level or character-level similarity
            const wordSimilarity = (matchCount / maxWords) * 100;
            const finalSimilarity = Math.max(wordSimilarity, charSimilarity * 100);

            return Math.round(Math.min(finalSimilarity, 100));
        }

        // Levenshtein distance for character similarity
        function getLevenshteinSimilarity(str1, str2) {
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;

            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            const distance = matrix[len2][len1];
            const maxLen = Math.max(len1, len2);
            return maxLen === 0 ? 1 : (maxLen - distance) / maxLen;
        }

        // Enhanced results display
        function showResults() {
            document.getElementById('testQuestion').style.display = 'none';
            document.getElementById('testResult').style.display = 'block';

            let totalScore = 0;
            const results = window.currentTest.answers.map(answer => {
                const similarity = calculateSimilarity(answer.userAnswer, answer.correctAnswer);
                totalScore += similarity;

                return {
                    ...answer,
                    score: similarity,
                    isCorrect: similarity >= 70
                };
            });

            const averageScore = Math.round(totalScore / 10);
            const correctCount = results.filter(r => r.isCorrect).length;

            // Save score to localStorage
            localStorage.setItem('lastTestScore', averageScore);

            // Determine performance level
            let performanceLevel, performanceIcon, performanceColor;
            if (averageScore >= 90) {
                performanceLevel = 'Xuất sắc';
                performanceIcon = 'fas fa-crown';
                performanceColor = '#f59e0b';
            } else if (averageScore >= 80) {
                performanceLevel = 'Tốt';
                performanceIcon = 'fas fa-star';
                performanceColor = '#10b981';
            } else if (averageScore >= 70) {
                performanceLevel = 'Khá';
                performanceIcon = 'fas fa-thumbs-up';
                performanceColor = '#06b6d4';
            } else if (averageScore >= 60) {
                performanceLevel = 'Trung bình';
                performanceIcon = 'fas fa-hand-paper';
                performanceColor = '#f59e0b';
            } else {
                performanceLevel = 'Cần cố gắng';
                performanceIcon = 'fas fa-fist-raised';
                performanceColor = '#ef4444';
            }

            document.getElementById('finalScore').innerHTML = `
               <div style="color: ${performanceColor}; margin-bottom: 15px;">
                   <i class="${performanceIcon}"></i> ${performanceLevel}
               </div>
               <div>Điểm số: ${averageScore}/100</div>
               <div style="font-size: 1.2rem; margin-top: 10px;">
                   ✅ Số câu đúng: ${correctCount}/10
               </div>
           `;

            const resultDetails = document.getElementById('resultDetails');
            resultDetails.innerHTML = results.map((result, index) => `
               <div class="result-item ${result.isCorrect ? 'correct' : 'incorrect'}">
                   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                       <strong>Câu ${index + 1}</strong>
                       <div style="background: ${result.isCorrect ? 'var(--success)' : 'var(--error)'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem;">
                           ${result.score}%
                       </div>
                   </div>
                   <div style="margin-bottom: 8px;"><strong>Đáp án:</strong> <span style="color: var(--success);">${escapeHtml(result.correctAnswer)}</span></div>
                   <div style="margin-bottom: 8px;"><strong>Bạn nhập:</strong> <span style="color: ${result.isCorrect ? 'var(--success)' : 'var(--error)'};">${escapeHtml(result.userAnswer)}</span></div>
                   <div><strong>Nghĩa:</strong> <em>${escapeHtml(result.question.vietnamese)}</em></div>
               </div>
           `).join('');

            // Update stats
            updateStats();

            // Show completion notification
            showNotification(`Hoàn thành bài kiểm tra! Điểm số: ${averageScore}/100`, 'success');
        }

        // Reset test
        function resetTest() {
            window.currentTest.isActive = false;
            window.currentTest.currentIndex = 0;
            window.currentTest.answers = [];
            window.currentTest.questions = [];

            document.getElementById('testStart').style.display = 'block';
            document.getElementById('testQuestion').style.display = 'none';
            document.getElementById('testResult').style.display = 'none';
        }

        // Keyboard shortcuts
        document.addEventListener('DOMContentLoaded', function () {
            // English input Enter -> Vietnamese input
            document.getElementById('englishInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    document.getElementById('vietnameseInput').focus();
                }
            });

            // Vietnamese input Enter -> Add card
            document.getElementById('vietnameseInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    addCard();
                }
            });

            // Test answer input Enter -> Next question
            document.addEventListener('keypress', function (e) {
                const answerInput = document.getElementById('answerInput');
                if (e.key === 'Enter' && answerInput && document.activeElement === answerInput) {
                    nextQuestion();
                }
            });

            // Space bar to replay audio during test
            document.addEventListener('keydown', function (e) {
                if (e.code === 'Space' && window.currentTest.isActive &&
                    document.getElementById('testQuestion').style.display === 'block') {
                    e.preventDefault();
                    playCurrentQuestion();
                }
            });
        });

        // Load voices when available
        if ('speechSynthesis' in window) {
            speechSynthesis.addEventListener('voiceschanged', function () {
                console.log('Voices loaded:', speechSynthesis.getVoices().length);
            });
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
           @keyframes slideInRight {
               from {
                   transform: translateX(100%);
                   opacity: 0;
               }
               to {
                   transform: translateX(0);
                   opacity: 1;
               }
           }
           
           @keyframes slideOutRight {
               from {
                   transform: translateX(0);
                   opacity: 1;
               }
               to {
                   transform: translateX(100%);
                   opacity: 0;
               }
           }
       `;
        document.head.appendChild(style);


        // Update voice info in UI
        function updateVoiceInfo() {
            const voices = speechSynthesis.getVoices();
            const englishVoices = voices.filter(voice => voice.lang.startsWith('en-'));
            const voiceCount = document.getElementById('voiceCount');

            if (voiceCount && englishVoices.length > 0) {
                const femaleVoices = englishVoices.filter(voice =>
                    voice.name.toLowerCase().includes('female') ||
                    ['alice', 'allison', 'ava', 'emma', 'fiona', 'karen', 'moira', 'samantha', 'sarah', 'susan', 'tessa', 'veena', 'victoria', 'zoe', 'hazel'].some(name =>
                        voice.name.toLowerCase().includes(name)
                    )
                );

                const maleVoices = englishVoices.filter(voice =>
                    voice.name.toLowerCase().includes('male') ||
                    ['alex', 'arthur', 'daniel', 'david', 'fred', 'george', 'james', 'john', 'lee', 'marcus', 'nathan', 'oliver', 'ralph', 'ryan', 'thomas', 'tom'].some(name =>
                        voice.name.toLowerCase().includes(name)
                    )
                );

                voiceCount.innerHTML = `
            Có ${englishVoices.length} giọng nói khác nhau 
            (${femaleVoices.length} nữ, ${maleVoices.length} nam, ${englishVoices.length - femaleVoices.length - maleVoices.length} khác)
        `;
            }
        }
    </script>
</body>

</html>