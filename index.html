<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán Listening Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéß</text></svg>">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%236366f1'/><text x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='50' fill='white'>üéß</text></svg>">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%236366f1'/><text x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='50' fill='white'>üéß</text></svg>">
    <link rel="icon" type="image/png" sizes="16x16" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%236366f1'/><text x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='50' fill='white'>üéß</text></svg>">
    <link rel="manifest" href="site.webmanifest">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab.active {
            background: white;
            color: var(--primary);
            font-weight: 600;
            transform: scale(1.02);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }

        .content {
            background: white;
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            min-height: 600px;
            backdrop-filter: blur(20px);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Practice Section */
        .section-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .add-card-form {
            background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--gray-200);
        }

        .add-card-form h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
z
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error), #dc2626);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-play {
            background: linear-gradient(135deg, var(--success), #059669);
            padding: 10px 16px;
            font-size: 14px;
        }

        .cards-container {
            margin-top: 30px;
        }

        .cards-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cards-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .card-count {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .card {
            background: white;
            border: 2px solid var(--gray-100);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.15);
        }

        .card:hover::before {
            transform: scaleY(1);
        }

        .card-content {
            flex: 1;
        }

        .card-english {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        .card-vietnamese {
            font-size: 1rem;
            color: var(--gray-600);
            font-style: italic;
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Test Section */
        .test-container {
            text-align: center;
        }

        .test-info {
            background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid #81d4fa;
        }

        .test-info h3 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 15px;
        }

        .test-info p {
            font-size: 1.1rem;
            color: var(--gray-600);
            margin-bottom: 10px;
        }

        .question-container {
            background: linear-gradient(135deg, var(--gray-50), white);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid var(--gray-100);
        }

        .question-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
        }

        .play-button {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 20px 40px;
            border: none;
            border-radius: 60px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 15px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .play-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.3);
        }

        .answer-input {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            font-size: 1.1rem;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .result-container {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 2px solid #86efac;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
        }

        .result-item {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .correct {
            border-left: 6px solid var(--success);
        }

        .incorrect {
            border-left: 6px solid var(--error);
        }

        .score {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray-500);
            font-size: 1.1rem;
        }

        .stats-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: linear-gradient(135deg, white, var(--gray-50));
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid var(--gray-100);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .content {
                padding: 25px;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .card {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .card-actions {
                justify-content: center;
            }
        }

        /* Animation for new cards */
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-new {
            animation: slideInDown 0.5s ease-out;
        }
    </style>
</head>
<body>
   <div class="container">
       <div class="header">
           <h1><i class="fas fa-headphones"></i> Luy·ªán Listening Pro</h1>
           <p>N√¢ng cao k·ªπ nƒÉng nghe ti·∫øng Anh c√πng Hz Chong </p>
       </div>

       <div class="tab-container">
           <button class="tab active" onclick="showTab('practice')">
               <i class="fas fa-book-open"></i>Th·∫ª
           </button>
           <button class="tab" onclick="showTab('test')">
               <i class="fas fa-clipboard-check"></i> Test 1
           </button>
           <button class="tab" onclick="showTab('meaning-test')">
               <i class="fas fa-brain"></i> Test 2
           </button>
       </div>

       <div class="content">
           <!-- Practice Section -->
           <div id="practice" class="section active">
               <h2 class="section-title">
                   <i class="fas fa-book-open"></i> Th·∫ª
               </h2>

               <div class="stats-card">
                   <div class="stat-item">
                       <span class="stat-number" id="totalCards">0</span>
                       <span class="stat-label">T·ªïng s·ªë th·∫ª</span>
                   </div>
                   <div class="stat-item">
                       <span class="stat-number" id="todayCards">0</span>
                       <span class="stat-label">Th·∫ª h√¥m nay</span>
                   </div>
                   <div class="stat-item">
                       <span class="stat-number" id="lastScore">0</span>
                       <span class="stat-label">ƒêi·ªÉm g·∫ßn nh·∫•t</span>
                   </div>
               </div>

               <div class="add-card-form">
                   <h3><i class="fas fa-plus-circle"></i> Th√™m th·∫ª m·ªõi</h3>
                   <div class="form-group">
                       <label><i class="fas fa-globe-americas"></i> Ti·∫øng Anh:</label>
                       <input type="text" id="englishInput" placeholder="Nh·∫≠p c√¢u ti·∫øng Anh...">
                   </div>
                   <div class="form-group">
                       <label><i class="fas fa-language"></i> Ti·∫øng Vi·ªát:</label>
                       <input type="text" id="vietnameseInput" placeholder="Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát...">
                   </div>
                   <button class="btn" onclick="addCard()">
                       <i class="fas fa-plus"></i> Th√™m Th·∫ª
                   </button>
               </div>

               <div class="cards-container">
                   <div class="cards-header">
                       <h3>Danh s√°ch th·∫ª</h3>
                       <div class="card-count" id="cardCount">0 th·∫ª</div>
                   </div>
                   <div id="cardsList">
                       <div class="loading">
                           <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...
                       </div>
                   </div>
               </div>
           </div>

           <!-- Test Section -->
           <div id="test" class="section">
               <h2 class="section-title">
                   <i class="fas fa-clipboard-check"></i> Ki·ªÉm Tra Nghe
               </h2>

               <div id="testStart" class="test-container">
                   <div class="test-info">
                       <h3><i class="fas fa-target"></i> B√†i ki·ªÉm tra nghe </h3>
                       <p>B·∫°n s·∫Ω nghe 10 c√¢u ti·∫øng Anh ng·∫´u nhi√™n v·ªõi <strong>4 gi·ªçng n√≥i</strong> 
                       (2 nam, 2 n·ªØ, t·ªëc ƒë·ªô ph√π h·ª£p) v√† nh·∫≠p l·∫°i nh·ªØng g√¨ b·∫°n nghe ƒë∆∞·ª£c.</p>
                       
                       <p><strong>ƒê·∫∑c bi·ªát:</strong> H·ªá th·ªëng s·ª≠ d·ª•ng 4 gi·ªçng n√≥i ƒë∆∞·ª£c t·ªëi ∆∞u ri√™ng  
                       v·ªõi t·ªëc ƒë·ªô v√† ƒë·ªô r√µ n√©t ph√π h·ª£p.</p>
                       <div id="voiceInfo"
                           style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 12px; font-size: 0.9rem; border: 1px solid rgba(99,102,241,0.2);">
                           <i class="fas fa-microphone"></i> <span id="voiceCount">ƒêang t·∫£i h·ªá th·ªëng gi·ªçng n√≥i ...</span>
                       </div>
                   </div>
                   <button class="btn btn-success" onclick="startTest()" id="startTestBtn">
                       <i class="fas fa-play"></i> B·∫Øt ƒê·∫ßu Ki·ªÉm Tra 
                   </button>
               </div>

               <div id="testQuestion" class="test-container" style="display: none;">
                   <div class="question-container">
                       <div class="question-number" id="questionNumber">C√¢u 1/10</div>
                       <button class="play-button" onclick="playCurrentQuestion()">
                           <i class="fas fa-volume-up"></i> Ph√°t √Çm
                       </button>
                       <input type="text" class="answer-input" id="answerInput"
                           placeholder="Nh·∫≠p nh·ªØng g√¨ b·∫°n nghe ƒë∆∞·ª£c...">
                       <div>
                           <button class="btn" onclick="nextQuestion()">
                               <i class="fas fa-arrow-right"></i> C√¢u Ti·∫øp Theo (Enter)
                           </button>
                       </div>
                       
                   </div>
               </div>

               <div id="testResult" class="test-container" style="display: none;">
                   <h3><i class="fas fa-trophy"></i> K·∫øt Qu·∫£ Ki·ªÉm Tra</h3>
                   <div class="score" id="finalScore"></div>
                   <div id="resultDetails"></div>
                   <button class="btn" onclick="resetTest()">
                       <i class="fas fa-redo"></i> L√†m L·∫°i
                   </button>
               </div>
           </div>

           <!-- Meaning Test Section -->
           <div id="meaning-test" class="section">
               <h2 class="section-title">
                   <i class="fas fa-brain"></i> Ki·ªÉm Tra Hi·ªÉu Nghƒ©a
               </h2>

               <div id="meaningTestStart" class="test-container">
                   <div class="test-info">
                       <h3><i class="fas fa-brain"></i> B√†i ki·ªÉm tra hi·ªÉu nghƒ©a</h3>
                       <p>B·∫°n s·∫Ω nghe 10 c√¢u ti·∫øng Anh v√† nh·∫≠p <strong>nghƒ©a ti·∫øng Vi·ªát</strong> m√† b·∫°n hi·ªÉu ƒë∆∞·ª£c.</p>
                       
                       <p><strong>L∆∞u √Ω:</strong> Kh√¥ng c·∫ßn d·ªãch t·ª´ng t·ª´, ch·ªâ c·∫ßn vi·∫øt nghƒ©a m√† b·∫°n hi·ªÉu ƒë∆∞·ª£c b·∫±ng ti·∫øng Vi·ªát.</p>
                       
                       <div id="meaningVoiceInfo"
                           style="margin-top: 15px; padding: 15px; background: rgba(255,193,7,0.1); border-radius: 12px; font-size: 0.9rem; border: 1px solid rgba(255,193,7,0.3);">
                           <i class="fas fa-lightbulb"></i> <span>T·∫≠p trung v√†o vi·ªác hi·ªÉu nghƒ©a chung c·ªßa c√¢u</span>
                       </div>
                   </div>
                   <button class="btn btn-warning" onclick="startMeaningTest()" id="startMeaningTestBtn">
                       <i class="fas fa-play"></i> B·∫Øt ƒê·∫ßu Ki·ªÉm Tra Hi·ªÉu Nghƒ©a
                   </button>
               </div>

               <div id="meaningTestQuestion" class="test-container" style="display: none;">
                   <div class="question-container">
                       <div class="question-number" id="meaningQuestionNumber">C√¢u 1/10</div>
                       <button class="play-button" onclick="playCurrentMeaningQuestion()" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                           <i class="fas fa-volume-up"></i> Ph√°t √Çm
                       </button>
                       <input type="text" class="answer-input" id="meaningAnswerInput"
                           placeholder="Nh·∫≠p nghƒ©a ti·∫øng Vi·ªát m√† b·∫°n hi·ªÉu ƒë∆∞·ª£c...">
                       <div>
                           <button class="btn btn-warning" onclick="nextMeaningQuestion()">
                               <i class="fas fa-arrow-right"></i> C√¢u Ti·∫øp Theo (Enter)
                           </button>
                       </div>
                   </div>
               </div>

               <div id="meaningTestResult" class="test-container" style="display: none;">
                   <h3><i class="fas fa-award"></i> K·∫øt Qu·∫£ Ki·ªÉm Tra Hi·ªÉu Nghƒ©a</h3>
                   <div class="score" id="meaningFinalScore"></div>
                   <div id="meaningResultDetails"></div>
                   <button class="btn btn-warning" onclick="resetMeaningTest()">
                       <i class="fas fa-redo"></i> L√†m L·∫°i
                   </button>
               </div>
           </div>
       </div>
   </div>

   <!-- Firebase SDK -->
   <script type="module">
       import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
       import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

       const firebaseConfig = {
           apiKey: "AIzaSyBrJh1921kNKJq6EF0U76pBD_VaGChgQqk",
           authDomain: "hz-listening.firebaseapp.com",
           projectId: "hz-listening",
           storageBucket: "hz-listening.firebasestorage.app",
           messagingSenderId: "1044959632237",
           appId: "1:1044959632237:web:d2fcc1294a83ca5349d864",
           measurementId: "G-SEY2ERMPDW"
       };

       const app = initializeApp(firebaseConfig);
       const db = getFirestore(app);

       // Global variables
       let cards = [];
       let currentTest = {
           questions: [],
           currentIndex: 0,
           answers: [],
           isActive: false
       };

       let currentMeaningTest = {
           questions: [],
           currentIndex: 0,
           answers: [],
           isActive: false,
           voiceForQuestions: []
       };

       // Make functions globally available
       window.db = db;
       window.collection = collection;
       window.addDoc = addDoc;
       window.getDocs = getDocs;
       window.deleteDoc = deleteDoc;
       window.doc = doc;
       window.cards = cards;
       window.currentTest = currentTest;
       window.currentMeaningTest = currentMeaningTest;

       // Load cards on page load
       loadCards();

       // Real-time listener for cards
       const unsubscribe = onSnapshot(collection(db, "cards"), (snapshot) => {
           cards.length = 0;
           snapshot.forEach((doc) => {
               cards.push({ id: doc.id, ...doc.data() });
           });
           displayCards();
           updateStats();
       });

       async function loadCards() {
           try {
               const querySnapshot = await getDocs(collection(db, "cards"));
               cards.length = 0;
               querySnapshot.forEach((doc) => {
                   cards.push({ id: doc.id, ...doc.data() });
               });
               displayCards();
               updateStats();
           } catch (error) {
               console.error("Error loading cards:", error);
               document.getElementById('cardsList').innerHTML = '<div class="loading"><i class="fas fa-exclamation-triangle"></i> L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
           }
       }

       window.loadCards = loadCards;
   </script>

   <script>
       // C·∫•u h√¨nh 4 gi·ªçng n√≥i chu·∫©n B1
       const voiceConfigs = [
           // N·ªØ tr·∫ª (20-30 tu·ªïi) - Gi·ªçng nƒÉng ƒë·ªông, r√µ r√†ng
           {
               type: 'young_female',
               rate: 0.85,           // T·ªëc ƒë·ªô v·ª´a ph·∫£i cho B1
               pitch: 1.2,           // Gi·ªçng cao, tr·∫ª trung
               volume: 1.0,
               preferredNames: ['samantha', 'emma', 'ava', 'sarah', 'zoe', 'alice'],
               description: 'üë©‚Äçü¶∞ N·ªØ tr·∫ª'
           },
           // N·ªØ trung ni√™n (35-50 tu·ªïi) - Gi·ªçng ·ªïn ƒë·ªãnh, r√µ r√†ng
           {
               type: 'mature_female',
               rate: 0.8,            // Ch·∫≠m h∆°n m·ªôt ch√∫t ƒë·ªÉ d·ªÖ nghe
               pitch: 1.0,           // Gi·ªçng trung t√≠nh
               volume: 1.0,
               preferredNames: ['susan', 'karen', 'moira', 'fiona', 'victoria', 'hazel'],
               description: 'üë©‚Äçüíº N·ªØ trung ni√™n'
           },
           // Nam tr·∫ª (20-30 tu·ªïi) - Gi·ªçng t∆∞∆°i tr·∫ª, r√µ r√†ng
           {
               type: 'young_male',
               rate: 0.9,            // H∆°i nhanh nh∆∞ng v·∫´n r√µ r√†ng
               pitch: 0.9,           // Gi·ªçng cao h∆°n nam trung ni√™n
               volume: 1.0,
               preferredNames: ['daniel', 'alex', 'ryan', 'james', 'nathan', 'oliver'],
               description: 'üë®‚Äçü¶± Nam tr·∫ª'
           },
           // Nam trung ni√™n (35-50 tu·ªïi) - Gi·ªçng tr·∫ßm ·ªïn, d·ªÖ nghe
           {
               type: 'mature_male',
               rate: 0.75,           // Ch·∫≠m r√£i, r√µ r√†ng cho B1
               pitch: 0.8,           // Gi·ªçng tr·∫ßm, ·ªïn ƒë·ªãnh
               volume: 1.0,
               preferredNames: ['david', 'thomas', 'george', 'arthur', 'tom', 'fred'],
               description: 'üë®‚Äçüíº Nam trung ni√™n'
           }
       ];

       // Tab switching with animation
       function showTab(tabName) {
           document.querySelectorAll('.section').forEach(section => {
               section.classList.remove('active');
           });

           document.querySelectorAll('.tab').forEach(tab => {
               tab.classList.remove('active');
           });

           document.getElementById(tabName).classList.add('active');
           event.target.classList.add('active');
       }

       // Update statistics
       function updateStats() {
           const today = new Date();
           today.setHours(0, 0, 0, 0);

           const todayCards = window.cards.filter(card => {
               const cardDate = card.createdAt?.toDate ? card.createdAt.toDate() : new Date(card.createdAt || 0);
               cardDate.setHours(0, 0, 0, 0);
               return cardDate.getTime() === today.getTime();
           }).length;

           document.getElementById('totalCards').textContent = window.cards.length;
           document.getElementById('todayCards').textContent = todayCards;

           const lastScore = localStorage.getItem('lastTestScore') || '0';
           document.getElementById('lastScore').textContent = lastScore;
       }

       // Add new card with animation
       async function addCard() {
           const english = document.getElementById('englishInput').value.trim();
           const vietnamese = document.getElementById('vietnameseInput').value.trim();

           if (!english || !vietnamese) {
               alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß n·ªôi dung ti·∫øng Anh v√† ti·∫øng Vi·ªát!');
               return;
           }

           try {
               await window.addDoc(window.collection(window.db, "cards"), {
                   english: english,
                   vietnamese: vietnamese,
                   createdAt: new Date()
               });

               // Clear inputs
               document.getElementById('englishInput').value = '';
               document.getElementById('vietnameseInput').value = '';

               // Show success message
               showNotification('Th·∫ª ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!', 'success');

               console.log('Card added successfully');
           } catch (error) {
               console.error("Error adding card:", error);
               showNotification('L·ªói khi th√™m th·∫ª: ' + error.message, 'error');
           }
       }

       // Delete card with confirmation
       async function deleteCard(cardId) {
           if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th·∫ª n√†y?')) {
               try {
                   await window.deleteDoc(window.doc(window.db, "cards", cardId));
                   showNotification('Th·∫ª ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!', 'success');
                   console.log('Card deleted successfully');
               } catch (error) {
                   console.error("Error deleting card:", error);
                   showNotification('L·ªói khi x√≥a th·∫ª: ' + error.message, 'error');
               }
           }
       }

       // Display cards with improved UI
       function displayCards() {
           const cardsList = document.getElementById('cardsList');
           const cardCount = document.getElementById('cardCount');

           cardCount.textContent = `${window.cards.length} th·∫ª`;

           if (window.cards.length === 0) {
               cardsList.innerHTML = '<div class="loading"><i class="fas fa-inbox"></i> Ch∆∞a c√≥ th·∫ª n√†o. H√£y th√™m th·∫ª ƒë·∫ßu ti√™n!</div>';
               return;
           }

           // Sort cards by creation time (newest first)
           const sortedCards = [...window.cards].sort((a, b) => {
               const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
               const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
               return dateB - dateA;
           });

           cardsList.innerHTML = sortedCards.map((card, index) => `
               <div class="card ${index === 0 ? 'card-new' : ''}">
                   <div class="card-content">
                       <div class="card-english">${escapeHtml(card.english)}</div>
                       <div class="card-vietnamese">${escapeHtml(card.vietnamese)}</div>
                   </div>
                   <div class="card-actions">
                       <button class="btn btn-play" onclick="speakText('${escapeForJs(card.english)}')">
                           <i class="fas fa-volume-up"></i> Voice
                       </button>
                       <button class="btn btn-danger" onclick="deleteCard('${card.id}')">
                           <i class="fas fa-trash"></i> X√≥a
                       </button>
                   </div>
               </div>
           `).join('');
       }

       // Escape HTML for security
       function escapeHtml(text) {
           const div = document.createElement('div');
           div.textContent = text;
           return div.innerHTML;
       }

       // Escape for JavaScript
       function escapeForJs(text) {
           return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
       }

       // Enhanced text to speech v·ªõi 4 gi·ªçng B1 c·ªë ƒë·ªãnh
       function speakText(text) {
           if ('speechSynthesis' in window) {
               speechSynthesis.cancel();

               const speakWithVoices = () => {
                   const voices = speechSynthesis.getVoices();

                   if (voices.length === 0) {
                       setTimeout(speakWithVoices, 100);
                       return;
                   }

                   const englishVoices = voices.filter(voice =>
                       voice.lang.startsWith('en-') && voice.name.length > 0
                   );

                   // Ch·ªçn m·ªôt trong 4 gi·ªçng c·ªë ƒë·ªãnh cho B1
                   const selectedConfig = voiceConfigs[Math.floor(Math.random() * 4)];
                   
                   // T√¨m gi·ªçng ph√π h·ª£p d·ª±a tr√™n t√™n ∆∞a th√≠ch
                   let selectedVoice = null;
                   for (const preferredName of selectedConfig.preferredNames) {
                       selectedVoice = englishVoices.find(voice => 
                           voice.name.toLowerCase().includes(preferredName)
                       );
                       if (selectedVoice) break;
                   }

                   // N·∫øu kh√¥ng t√¨m th·∫•y gi·ªçng ∆∞a th√≠ch, ch·ªçn d·ª±a tr√™n gi·ªõi t√≠nh
                   if (!selectedVoice) {
                       if (selectedConfig.type.includes('female')) {
                           selectedVoice = englishVoices.find(voice => 
                               voice.name.toLowerCase().includes('female') ||
                               ['alice', 'allison', 'ava', 'emma', 'fiona', 'karen', 'moira', 'samantha', 'sarah', 'susan', 'tessa', 'veena', 'victoria', 'zoe', 'hazel'].some(name =>
                                   voice.name.toLowerCase().includes(name)
                               )
                           );
                       } else {
                           selectedVoice = englishVoices.find(voice => 
                               voice.name.toLowerCase().includes('male') ||
                               ['alex', 'arthur', 'daniel', 'david', 'fred', 'george', 'james', 'john', 'lee', 'marcus', 'nathan', 'oliver', 'ralph', 'ryan', 'thomas', 'tom'].some(name =>
                                   voice.name.toLowerCase().includes(name)
                               )
                           );
                       }
                   }

                   // Fallback: ch·ªçn gi·ªçng ti·∫øng Anh b·∫•t k·ª≥
                   if (!selectedVoice && englishVoices.length > 0) {
                       selectedVoice = englishVoices[0];
                   }

                   const utterance = new SpeechSynthesisUtterance(text);

                   if (selectedVoice) {
                       utterance.voice = selectedVoice;
                       utterance.lang = selectedVoice.lang;
                   }

                   // √Åp d·ª•ng c·∫•u h√¨nh gi·ªçng n√≥i B1 c·ªë ƒë·ªãnh
                   utterance.rate = selectedConfig.rate;
                   utterance.pitch = selectedConfig.pitch;
                   utterance.volume = selectedConfig.volume;

                   // Hi·ªÉn th·ªã th√¥ng tin gi·ªçng ƒëang s·ª≠ d·ª•ng (cho debugging)
                   console.log(`Voice: ${selectedConfig.description} - Rate: ${selectedConfig.rate} - ${selectedVoice ? selectedVoice.name : 'Default'}`);

                   utterance.addEventListener('error', (e) => {
                       console.error('Speech synthesis error:', e);
                       showNotification('Please wait to load!', 'error');
                   });

                   speechSynthesis.speak(utterance);
               };

               speakWithVoices();
           } else {
               showNotification('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ t√≠nh nƒÉng ƒë·ªçc vƒÉn b·∫£n!', 'error');
           }
       }

       // C·∫≠p nh·∫≠t h√†m updateVoiceInfo ƒë·ªÉ hi·ªÉn th·ªã 4 gi·ªçng B1
       function updateVoiceInfo() {
           const voices = speechSynthesis.getVoices();
           const englishVoices = voices.filter(voice => voice.lang.startsWith('en-'));
           const voiceCount = document.getElementById('voiceCount');

           if (voiceCount && englishVoices.length > 0) {
               voiceCount.innerHTML = `
                   <strong>üéØ H·ªá th·ªëng 4 gi·ªçng n√≥i:</strong><br>
                   <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                       <div>üë©‚Äçü¶∞ N·ªØ tr·∫ª (t·ªëc ƒë·ªô 0.85)</div>
                       <div>üë©‚Äçüíº N·ªØ trung ni√™n (t·ªëc ƒë·ªô 0.8)</div>
                       <div>üë®‚Äçü¶± Nam tr·∫ª (t·ªëc ƒë·ªô 0.9)</div>
                       <div>üë®‚Äçüíº Nam trung ni√™n (t·ªëc ƒë·ªô 0.75)</div>
                   </div>
                   <div style="margin-top: 8px; font-size: 0.85em; font-style: italic;">
                       ‚úÖ T·ªëc ƒë·ªô ƒë∆∞·ª£c t·ªëi ∆∞u 
                   </div>
               `;
           }
       }

       // Initialize voices on page load
       function initializeVoices() {
           if ('speechSynthesis' in window) {
               const loadVoices = () => {
                   const voices = speechSynthesis.getVoices();
                   if (voices.length > 0) {
                       console.log('Available voices loaded:', voices.length);
                       const englishVoices = voices.filter(voice => voice.lang.startsWith('en-'));
                       console.log('English voices available:', englishVoices.map(v => `${v.name} (${v.lang})`));
                       
                       updateVoiceInfo();
                       
                       if (englishVoices.length > 0) {
                           showNotification(`‚úÖ ƒê√£ t·∫£i h·ªá th·ªëng 4 gi·ªçng n√≥i!`, 'success');
                       }
                   } else {
                       setTimeout(loadVoices, 100);
                   }
               };

               speechSynthesis.addEventListener('voiceschanged', loadVoices);
               loadVoices();
           }
       }

       // Show notification
       function showNotification(message, type = 'info') {
           const notification = document.createElement('div');
           notification.className = `notification notification-${type}`;
           notification.innerHTML = `
              <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
              ${message}
          `;

           notification.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              padding: 15px 20px;
              border-radius: 10px;
              color: white;
              font-weight: 600;
              z-index: 1000;
              animation: slideInRight 0.3s ease-out;
              max-width: 320px;
              box-shadow: 0 4px 20px rgba(0,0,0,0.15);
          `;

           switch (type) {
               case 'success':
                   notification.style.background = 'linear-gradient(135deg, var(--success), #059669)';
                   break;
               case 'error':
                   notification.style.background = 'linear-gradient(135deg, var(--error), #dc2626)';
                   break;
               default:
                   notification.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-dark))';
           }

           document.body.appendChild(notification);

           setTimeout(() => {
               notification.style.animation = 'slideOutRight 0.3s ease-in';
               setTimeout(() => {
                   if (document.body.contains(notification)) {
                       document.body.removeChild(notification);
                   }
               }, 300);
           }, 3000);
       }

       // Start test v·ªõi th√¥ng b√°o v·ªÅ 4 gi·ªçng B1
       function startTest() {
           if (window.cards.length < 10) {
               showNotification(`B·∫°n c·∫ßn c√≥ √≠t nh·∫•t 10 th·∫ª ƒë·ªÉ l√†m b√†i ki·ªÉm tra. Hi·ªán t·∫°i b·∫°n c√≥ ${window.cards.length} th·∫ª.`, 'error');
               return;
           }

           // Shuffle and select 10 random cards
           const shuffled = [...window.cards].sort(() => Math.random() - 0.5);
           window.currentTest.questions = shuffled.slice(0, 10);
           window.currentTest.currentIndex = 0;
           window.currentTest.answers = [];
           window.currentTest.isActive = true;
           // G√°n gi·ªçng n√≥i c·ªë ƒë·ªãnh cho t·ª´ng c√¢u
           window.currentTest.voiceForQuestions = [];
           window.currentTest.questions.forEach(() => {
               const selectedConfig = voiceConfigs[Math.floor(Math.random() * 4)];
               window.currentTest.voiceForQuestions.push(selectedConfig);
           });

           // Show test interface
           document.getElementById('testStart').style.display = 'none';
           document.getElementById('testQuestion').style.display = 'block';
           document.getElementById('testResult').style.display = 'none';

           showCurrentQuestion();
           showNotification('üéØ B·∫Øt ƒë·∫ßu v·ªõi 4 gi·ªçng n√≥i! Ch√∫c b·∫°n may m·∫Øn!', 'success');
       }

       // Show current question with progress
       function showCurrentQuestion() {
           const questionNumber = document.getElementById('questionNumber');
           const answerInput = document.getElementById('answerInput');

           questionNumber.innerHTML = `
              <i class="fas fa-question-circle"></i> 
              C√¢u ${window.currentTest.currentIndex + 1}/10 
              <div style="width: 100%; background: var(--gray-200); border-radius: 10px; height: 8px; margin-top: 10px;">
                  <div style="width: ${(window.currentTest.currentIndex + 1) * 10}%; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 10px; height: 100%; transition: all 0.5s ease;"></div>
              </div>
          `;
           answerInput.value = '';
           answerInput.focus();

           // Auto-play the question after a short delay
           setTimeout(() => {
               playCurrentQuestion();
           }, 500);
       }

       // Play current question with voice
       function playCurrentQuestion() {
           const currentQuestion = window.currentTest.questions[window.currentTest.currentIndex];
           const assignedVoice = window.currentTest.voiceForQuestions[window.currentTest.currentIndex];
           speakTextWithSpecificVoice(currentQuestion.english, assignedVoice);
       }

       // Next question with validation
       function nextQuestion() {
           const answerInput = document.getElementById('answerInput');
           const userAnswer = answerInput.value.trim();

           if (!userAnswer) {
               showNotification('Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi!', 'error');
               answerInput.focus();
               return;
           }

           // Save answer
           window.currentTest.answers.push({
               question: window.currentTest.questions[window.currentTest.currentIndex],
               userAnswer: userAnswer,
               correctAnswer: window.currentTest.questions[window.currentTest.currentIndex].english
           });

           window.currentTest.currentIndex++;

           if (window.currentTest.currentIndex < 10) {
               showCurrentQuestion();
           } else {
               showResults();
           }
       }

       // Enhanced similarity calculation for B1 level
       function calculateSimilarity(str1, str2) {
           const normalize = (str) => str.toLowerCase()
               .replace(/[^\w\s]/g, '')
               .replace(/\s+/g, ' ')
               .trim();

           const s1 = normalize(str1);
           const s2 = normalize(str2);

           if (s1 === s2) return 100;

           const words1 = s1.split(' ');
           const words2 = s2.split(' ');

           // Calculate word-level similarity v·ªõi ƒë·ªô khoan dung cho B1
           let matchCount = 0;
           const maxWords = Math.max(words1.length, words2.length);

           words1.forEach(word1 => {
               const bestMatch = words2.reduce((best, word2) => {
                   const similarity = getLevenshteinSimilarity(word1, word2);
                   return similarity > best ? similarity : best;
               }, 0);

               if (bestMatch > 0.65) { // 65% similarity threshold for B1 level
                   matchCount += bestMatch;
               } else if (words2.includes(word1)) {
                   matchCount += 1;
               }
           });

           const charSimilarity = getLevenshteinSimilarity(s1, s2);
           const wordSimilarity = (matchCount / maxWords) * 100;
           const finalSimilarity = Math.max(wordSimilarity, charSimilarity * 100);

           return Math.round(Math.min(finalSimilarity, 100));
       }

       // Levenshtein distance for character similarity
       function getLevenshteinSimilarity(str1, str2) {
           const matrix = [];
           const len1 = str1.length;
           const len2 = str2.length;

           for (let i = 0; i <= len2; i++) {
               matrix[i] = [i];
           }

           for (let j = 0; j <= len1; j++) {
               matrix[0][j] = j;
           }

           for (let i = 1; i <= len2; i++) {
               for (let j = 1; j <= len1; j++) {
                   if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                       matrix[i][j] = matrix[i - 1][j - 1];
                   } else {
                       matrix[i][j] = Math.min(
                           matrix[i - 1][j - 1] + 1,
                           matrix[i][j - 1] + 1,
                           matrix[i - 1][j] + 1
                       );
                   }
               }
           }

           const distance = matrix[len2][len1];
           const maxLen = Math.max(len1, len2);
           return maxLen === 0 ? 1 : (maxLen - distance) / maxLen;
       }

       // Enhanced results display cho B1
       function showResults() {
           document.getElementById('testQuestion').style.display = 'none';
           document.getElementById('testResult').style.display = 'block';

           let totalScore = 0;
           const results = window.currentTest.answers.map(answer => {
               const similarity = calculateSimilarity(answer.userAnswer, answer.correctAnswer);
               totalScore += similarity;

               return {
                   ...answer,
                   score: similarity,
                   isCorrect: similarity >= 65  // ƒêi·ªÅu ch·ªânh threshold cho B1
               };
           });

           const averageScore = Math.round(totalScore / 10);
           const correctCount = results.filter(r => r.isCorrect).length;

           // Save score to localStorage
           localStorage.setItem('lastTestScore', averageScore);

           // Determine performance level cho B1
           let performanceLevel, performanceIcon, performanceColor, advice;
           if (averageScore >= 85) {
               performanceLevel = 'Xu·∫•t s·∫Øc!';
               performanceIcon = 'fas fa-crown';
               performanceColor = '#f59e0b';
               advice = 'B·∫°n ƒë√£ s·∫µn s√†ng cho th·ª≠ th√°ch ti·∫øp theo! üéâ';
           } else if (averageScore >= 75) {
               performanceLevel = 'T·ªët - n·ªÅn t·∫£ng v·ªØng';
               performanceIcon = 'fas fa-star';
               performanceColor = '#10b981';
               advice = 'Tr√¨nh ƒë·ªô t·ªët, ti·∫øp t·ª•c ph√°t huy! üëç';
           } else if (averageScore >= 65) {
               performanceLevel = 'ƒê·∫°t';
               performanceIcon = 'fas fa-thumbs-up';
               performanceColor = '#06b6d4';
               advice = 'ƒê√£ ƒë·∫°t, c·∫ßn luy·ªán th√™m ƒë·ªÉ v·ªØng h∆°n. üí™';
           } else if (averageScore >= 55) {
               performanceLevel = 'C√≥ c·ªë g·∫Øng';
               performanceIcon = 'fas fa-hand-paper';
               performanceColor = '#f59e0b';
               advice = 'C·∫ßn c·ªë g·∫Øng h∆°n, c·∫ßn luy·ªán th√™m listening! üìö';
           } else {
               performanceLevel = 'Ch∆∞a ƒë·∫°t';
               performanceIcon = 'fas fa-fist-raised';
               performanceColor = '#ef4444';
               advice = 'C·∫ßn luy·ªán t·∫≠p th√™m. ƒê·ª´ng b·ªè cu·ªôc! üî•';
           }

           document.getElementById('finalScore').innerHTML = `
             <div style="color: ${performanceColor}; margin-bottom: 15px;">
                 <i class="${performanceIcon}"></i> ${performanceLevel}
             </div>
             <div>ƒêi·ªÉm s·ªë: ${averageScore}/100</div>
             <div style="font-size: 1.2rem; margin-top: 10px;">
                 ‚úÖ S·ªë c√¢u ƒë√∫ng: ${correctCount}/10 (‚â•65%)
             </div>
             <div style="font-size: 1rem; margin-top: 15px; color: var(--gray-600); font-style: italic;">
                 ${advice}
             </div>
         `;

           const resultDetails = document.getElementById('resultDetails');
           resultDetails.innerHTML = results.map((result, index) => `
               <div class="result-item ${result.isCorrect ? 'correct' : 'incorrect'}">
                   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                       <strong>C√¢u ${index + 1}</strong>
                       <div style="display: flex; gap: 10px; align-items: center;">
                           <button class="btn btn-play" style="padding: 6px 12px; font-size: 0.8rem;" onclick="replayResultQuestion(${index})">
                               <i class="fas fa-volume-up"></i> Nghe l·∫°i
                           </button>
                           <div style="background: ${result.isCorrect ? 'var(--success)' : 'var(--error)'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem;">
                               ${result.score}%
                           </div>
                           <div style="font-size: 0.8rem; color: var(--gray-500);">
                               ${result.score >= 85 ? 'üåü Ho√†n h·∫£o' : result.score >= 75 ? '‚úÖ T·ªët' : result.score >= 65 ? 'üëç ƒê·∫°t' : result.score >= 50 ? '‚ö†Ô∏è G·∫ßn' : '‚ùå Sai'}
                           </div>
                       </div>
                   </div>
                   <div style="margin-bottom: 8px;"><strong>ƒê√°p √°n:</strong> <span style="color: var(--success); font-weight: 600;">${escapeHtml(result.correctAnswer)}</span></div>
                   <div style="margin-bottom: 8px;"><strong>B·∫°n nh·∫≠p:</strong> <span style="color: ${result.isCorrect ? 'var(--success)' : 'var(--error)'}; font-weight: 500;">${escapeHtml(result.userAnswer)}</span></div>
                   <div><strong>Nghƒ©a:</strong> <em style="color: var(--gray-600);">${escapeHtml(result.question.vietnamese)}</em></div>
               </div>
           `).join('');

           // Update stats
           updateStats();

           // Show completion notification with B1 context
           const notificationMessage = averageScore >= 65 ? 
               `üéØ Ho√†n th√†nh b√†i test! ƒêi·ªÉm: ${averageScore}/100 - ${performanceLevel}` :
               `üìä Ho√†n th√†nh b√†i test! ƒêi·ªÉm: ${averageScore}/100 - Ti·∫øp t·ª•c luy·ªán ƒë·ªÉ ƒë·∫°t B1!`;
           
           showNotification(notificationMessage, averageScore >= 65 ? 'success' : 'info');
       }

       // Reset test
       function resetTest() {
           window.currentTest.isActive = false;
           window.currentTest.currentIndex = 0;
           window.currentTest.answers = [];
           window.currentTest.questions = [];

           document.getElementById('testStart').style.display = 'block';
           document.getElementById('testQuestion').style.display = 'none';
           document.getElementById('testResult').style.display = 'none';
       }

       // Start meaning test
       function startMeaningTest() {
           if (window.cards.length < 10) {
               showNotification(`B·∫°n c·∫ßn c√≥ √≠t nh·∫•t 10 th·∫ª ƒë·ªÉ l√†m b√†i ki·ªÉm tra. Hi·ªán t·∫°i b·∫°n c√≥ ${window.cards.length} th·∫ª.`, 'error');
               return;
           }

           // Shuffle and select 10 random cards
           const shuffled = [...window.cards].sort(() => Math.random() - 0.5);
           window.currentMeaningTest.questions = shuffled.slice(0, 10);
           window.currentMeaningTest.currentIndex = 0;
           window.currentMeaningTest.answers = [];
           window.currentMeaningTest.isActive = true;
           
           // Assign voice for each question
           window.currentMeaningTest.voiceForQuestions = [];
           window.currentMeaningTest.questions.forEach(() => {
               const selectedConfig = voiceConfigs[Math.floor(Math.random() * 4)];
               window.currentMeaningTest.voiceForQuestions.push(selectedConfig);
           });

           // Show test interface
           document.getElementById('meaningTestStart').style.display = 'none';
           document.getElementById('meaningTestQuestion').style.display = 'block';
           document.getElementById('meaningTestResult').style.display = 'none';

           showCurrentMeaningQuestion();
           showNotification('üß† B·∫Øt ƒë·∫ßu ki·ªÉm tra hi·ªÉu nghƒ©a! T·∫≠p trung v√†o nghƒ©a chung c·ªßa c√¢u!', 'success');
       }

       // Show current meaning question
       function showCurrentMeaningQuestion() {
           const questionNumber = document.getElementById('meaningQuestionNumber');
           const answerInput = document.getElementById('meaningAnswerInput');

           questionNumber.innerHTML = `
               <i class="fas fa-brain"></i> 
               C√¢u ${window.currentMeaningTest.currentIndex + 1}/10 
               <div style="width: 100%; background: var(--gray-200); border-radius: 10px; height: 8px; margin-top: 10px;">
                   <div style="width: ${(window.currentMeaningTest.currentIndex + 1) * 10}%; background: linear-gradient(135deg, #ff9800, #f57c00); border-radius: 10px; height: 100%; transition: all 0.5s ease;"></div>
               </div>
           `;
           answerInput.value = '';
           answerInput.focus();

           // Auto-play the question after a short delay
           setTimeout(() => {
               playCurrentMeaningQuestion();
           }, 500);
       }

       // Play current meaning question
       function playCurrentMeaningQuestion() {
           const currentQuestion = window.currentMeaningTest.questions[window.currentMeaningTest.currentIndex];
           const assignedVoice = window.currentMeaningTest.voiceForQuestions[window.currentMeaningTest.currentIndex];
           speakTextWithSpecificVoice(currentQuestion.english, assignedVoice);
       }

       // Next meaning question
       function nextMeaningQuestion() {
           const answerInput = document.getElementById('meaningAnswerInput');
           const userAnswer = answerInput.value.trim();

           if (!userAnswer) {
               showNotification('Vui l√≤ng nh·∫≠p nghƒ©a ti·∫øng Vi·ªát!', 'error');
               answerInput.focus();
               return;
           }

           // Save answer
           window.currentMeaningTest.answers.push({
               question: window.currentMeaningTest.questions[window.currentMeaningTest.currentIndex],
               userAnswer: userAnswer,
               correctAnswer: window.currentMeaningTest.questions[window.currentMeaningTest.currentIndex].vietnamese
           });

           window.currentMeaningTest.currentIndex++;

           if (window.currentMeaningTest.currentIndex < 10) {
               showCurrentMeaningQuestion();
           } else {
               showMeaningResults();
           }
       }

       // Calculate meaning similarity (more flexible for Vietnamese)
       function calculateMeaningSimilarity(userAnswer, correctAnswer) {
           const normalize = (str) => str.toLowerCase()
               .replace(/[^\w\s√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/g, '')
               .replace(/\s+/g, ' ')
               .trim();

           const user = normalize(userAnswer);
           const correct = normalize(correctAnswer);

           if (user === correct) return 100;

           // Check for key word matches
           const userWords = user.split(' ').filter(w => w.length > 2);
           const correctWords = correct.split(' ').filter(w => w.length > 2);
           
           let keyWordMatches = 0;
           userWords.forEach(userWord => {
               if (correctWords.some(correctWord => 
                   correctWord.includes(userWord) || userWord.includes(correctWord) ||
                   getLevenshteinSimilarity(userWord, correctWord) > 0.7
               )) {
                   keyWordMatches++;
               }
           });

           const keyWordScore = Math.min((keyWordMatches / Math.max(correctWords.length, 1)) * 100, 100);
           const charSimilarity = getLevenshteinSimilarity(user, correct) * 100;
           
           return Math.round(Math.max(keyWordScore, charSimilarity));
       }

       // Show meaning test results
       function showMeaningResults() {
           document.getElementById('meaningTestQuestion').style.display = 'none';
           document.getElementById('meaningTestResult').style.display = 'block';

           let totalScore = 0;
           const results = window.currentMeaningTest.answers.map(answer => {
               const similarity = calculateMeaningSimilarity(answer.userAnswer, answer.correctAnswer);
               totalScore += similarity;

               return {
                   ...answer,
                   score: similarity,
                   isCorrect: similarity >= 60  // Lower threshold for meaning understanding
               };
           });

           const averageScore = Math.round(totalScore / 10);
           const correctCount = results.filter(r => r.isCorrect).length;

           // Save score to localStorage
           localStorage.setItem('lastMeaningTestScore', averageScore);

           // Determine performance level
           let performanceLevel, performanceIcon, performanceColor, advice;
           if (averageScore >= 85) {
               performanceLevel = 'Xu·∫•t s·∫Øc!';
               performanceIcon = 'fas fa-crown';
               performanceColor = '#f59e0b';
               advice = 'Kh·∫£ nƒÉng hi·ªÉu nghƒ©a tuy·ªát v·ªùi! üéâ';
           } else if (averageScore >= 75) {
               performanceLevel = 'T·ªët - hi·ªÉu nghƒ©a r·∫•t t·ªët';
               performanceIcon = 'fas fa-star';
               performanceColor = '#10b981';
               advice = 'Kh·∫£ nƒÉng hi·ªÉu nghƒ©a t·ªët! üëç';
           } else if (averageScore >= 60) {
               performanceLevel = 'ƒê·∫°t - hi·ªÉu ƒë∆∞·ª£c c∆° b·∫£n';
               performanceIcon = 'fas fa-thumbs-up';
               performanceColor = '#06b6d4';
               advice = 'C·∫ßn luy·ªán th√™m ƒë·ªÉ hi·ªÉu nghƒ©a ch√≠nh x√°c h∆°n! üí™';
           } else {
               performanceLevel = 'C·∫ßn c·∫£i thi·ªán';
               performanceIcon = 'fas fa-fist-raised';
               performanceColor = '#ef4444';
               advice = 'C·∫ßn luy·ªán th√™m kh·∫£ nƒÉng hi·ªÉu nghƒ©a! üî•';
           }

           document.getElementById('meaningFinalScore').innerHTML = `
               <div style="color: ${performanceColor}; margin-bottom: 15px;">
                   <i class="${performanceIcon}"></i> ${performanceLevel}
               </div>
               <div>ƒêi·ªÉm s·ªë: ${averageScore}/100</div>
               <div style="font-size: 1.2rem; margin-top: 10px;">
                   ‚úÖ S·ªë c√¢u hi·ªÉu ƒë√∫ng nghƒ©a: ${correctCount}/10 (‚â•60%)
               </div>
               <div style="font-size: 1rem; margin-top: 15px; color: var(--gray-600); font-style: italic;">
                   ${advice}
               </div>
           `;

           const resultDetails = document.getElementById('meaningResultDetails');
           resultDetails.innerHTML = results.map((result, index) => `
               <div class="result-item ${result.isCorrect ? 'correct' : 'incorrect'}">
                   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                       <strong>C√¢u ${index + 1}</strong>
                       <div style="display: flex; gap: 10px; align-items: center;">
                           <button class="btn btn-play" style="padding: 6px 12px; font-size: 0.8rem; background: linear-gradient(135deg, #ff9800, #f57c00);" onclick="replayMeaningResultQuestion(${index})">
                               <i class="fas fa-volume-up"></i> Nghe l·∫°i
                           </button>
                           <div style="background: ${result.isCorrect ? 'var(--success)' : 'var(--error)'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem;">
                               ${result.score}%
                           </div>
                       </div>
                   </div>
                   <div style="margin-bottom: 8px;"><strong>C√¢u g·ªëc:</strong> <span style="color: var(--primary); font-weight: 600;">${escapeHtml(result.question.english)}</span></div>
                   <div style="margin-bottom: 8px;"><strong>Nghƒ©a ƒë√∫ng:</strong> <span style="color: var(--success); font-weight: 600;">${escapeHtml(result.correctAnswer)}</span></div>
                   <div><strong>B·∫°n hi·ªÉu:</strong> <span style="color: ${result.isCorrect ? 'var(--success)' : 'var(--error)'}; font-weight: 500;">${escapeHtml(result.userAnswer)}</span></div>
               </div>
           `).join('');

           showNotification(`üß† Ho√†n th√†nh ki·ªÉm tra hi·ªÉu nghƒ©a! ƒêi·ªÉm: ${averageScore}/100`, 'success');
       }

       // Reset meaning test
       function resetMeaningTest() {
           window.currentMeaningTest.isActive = false;
           window.currentMeaningTest.currentIndex = 0;
           window.currentMeaningTest.answers = [];
           window.currentMeaningTest.questions = [];
           window.currentMeaningTest.voiceForQuestions = [];

           document.getElementById('meaningTestStart').style.display = 'block';
           document.getElementById('meaningTestQuestion').style.display = 'none';
           document.getElementById('meaningTestResult').style.display = 'none';
       }

       // Replay question in meaning test results
       function replayMeaningResultQuestion(questionIndex) {
           if (window.currentMeaningTest.questions && window.currentMeaningTest.voiceForQuestions) {
               const question = window.currentMeaningTest.questions[questionIndex];
               const voiceConfig = window.currentMeaningTest.voiceForQuestions[questionIndex];
               speakTextWithSpecificVoice(question.english, voiceConfig);
           }
       }

       // H√†m ph√°t √¢m v·ªõi gi·ªçng n√≥i ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh
       function speakTextWithSpecificVoice(text, voiceConfig) {
           if ('speechSynthesis' in window) {
               speechSynthesis.cancel();

               const speakWithVoices = () => {
                   const voices = speechSynthesis.getVoices();
                   if (voices.length === 0) {
                       setTimeout(speakWithVoices, 100);
                       return;
                   }

                   const englishVoices = voices.filter(voice =>
                       voice.lang.startsWith('en-') && voice.name.length > 0
                   );

                   // T√¨m gi·ªçng ph√π h·ª£p d·ª±a tr√™n config ƒë√£ ch·ªâ ƒë·ªãnh
                   let selectedVoice = null;
                   for (const preferredName of voiceConfig.preferredNames) {
                       selectedVoice = englishVoices.find(voice => 
                           voice.name.toLowerCase().includes(preferredName)
                       );
                       if (selectedVoice) break;
                   }

                   if (!selectedVoice) {
                       if (voiceConfig.type.includes('female')) {
                           selectedVoice = englishVoices.find(voice => 
                               voice.name.toLowerCase().includes('female') ||
                               ['alice', 'allison', 'ava', 'emma', 'fiona', 'karen', 'moira', 'samantha', 'sarah', 'susan', 'tessa', 'veena', 'victoria', 'zoe', 'hazel'].some(name =>
                                   voice.name.toLowerCase().includes(name)
                               )
                           );
                       } else {
                           selectedVoice = englishVoices.find(voice => 
                               voice.name.toLowerCase().includes('male') ||
                               ['alex', 'arthur', 'daniel', 'david', 'fred', 'george', 'james', 'john', 'lee', 'marcus', 'nathan', 'oliver', 'ralph', 'ryan', 'thomas', 'tom'].some(name =>
                                   voice.name.toLowerCase().includes(name)
                               )
                           );
                       }
                   }

                   if (!selectedVoice && englishVoices.length > 0) {
                       selectedVoice = englishVoices[0];
                   }

                   const utterance = new SpeechSynthesisUtterance(text);
                   if (selectedVoice) {
                       utterance.voice = selectedVoice;
                       utterance.lang = selectedVoice.lang;
                   }

                   utterance.rate = voiceConfig.rate;
                   utterance.pitch = voiceConfig.pitch;
                   utterance.volume = voiceConfig.volume;

                   utterance.addEventListener('error', (e) => {
                       console.error('Speech synthesis error:', e);
                       showNotification('Please wait to load!', 'error');
                   });

                   speechSynthesis.speak(utterance);
               };

               speakWithVoices();
           }
       }

       // Replay question in listening test results
       function replayResultQuestion(questionIndex) {
           if (window.currentTest.questions && window.currentTest.voiceForQuestions) {
               const question = window.currentTest.questions[questionIndex];
               const voiceConfig = window.currentTest.voiceForQuestions[questionIndex];
               speakTextWithSpecificVoice(question.english, voiceConfig);
           }
       }

       // Keyboard shortcuts v√† event listeners
       document.addEventListener('DOMContentLoaded', function () {
           // Initialize voices when page loads
           initializeVoices();

           // English input Enter -> Vietnamese input
           document.getElementById('englishInput').addEventListener('keypress', function (e) {
               if (e.key === 'Enter') {
                   document.getElementById('vietnameseInput').focus();
               }
           });

           // Vietnamese input Enter -> Add card
           document.getElementById('vietnameseInput').addEventListener('keypress', function (e) {
               if (e.key === 'Enter') {
                   addCard();
               }
           });

           // Test answer input Enter -> Next question
           document.addEventListener('keypress', function (e) {
               const answerInput = document.getElementById('answerInput');
               if (e.key === 'Enter' && answerInput && document.activeElement === answerInput) {
                   nextQuestion();
               }
           });

           // Meaning test answer input Enter -> Next question
           document.addEventListener('keypress', function (e) {
               const meaningAnswerInput = document.getElementById('meaningAnswerInput');
               if (e.key === 'Enter' && meaningAnswerInput && document.activeElement === meaningAnswerInput) {
                   nextMeaningQuestion();
               }
           });

           // Update voice info periodically
           setTimeout(() => {
               updateVoiceInfo();
           }, 1000);
       });

       // Load voices when available
       if ('speechSynthesis' in window) {
           speechSynthesis.addEventListener('voiceschanged', function () {
               console.log('Voices loaded:', speechSynthesis.getVoices().length);
               updateVoiceInfo();
           });
       }

       // Add CSS animations
       const style = document.createElement('style');
       style.textContent = `
         @keyframes slideInRight {
             from {
                 transform: translateX(100%);
                 opacity: 0;
             }
             to {
                 transform: translateX(0);
                 opacity: 1;
             }
         }
         
         @keyframes slideOutRight {
             from {
                 transform: translateX(0);
                 opacity: 1;
             }
             to {
                 transform: translateX(100%);
                 opacity: 0;
             }
         }

         /* Enhanced styles for B1 level */
         .test-info {
             background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
             border: 2px solid #2196f3 !important;
         }

         .question-container {
             border: 2px solid var(--primary) !important;
             background: linear-gradient(135deg, #f8faff, white) !important;
         }

         .play-button {
             background: linear-gradient(135deg, #2196f3, #1976d2) !important;
             box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
         }

         .play-button:hover {
             transform: scale(1.05) !important;
             box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4) !important;
         }

         /* B1 Voice button styling */
         .btn-play {
             background: linear-gradient(135deg, #2196f3, #1976d2) !important;
             color: white !important;
         }

         .btn-play:hover {
             box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3) !important;
         }

         /* Meaning test specific styles */
         #meaning-test .test-info {
             background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
             border: 2px solid #ff9800 !important;
         }

         #meaning-test .question-container {
             border: 2px solid #ff9800 !important;
             background: linear-gradient(135deg, #fffbf0, white) !important;
         }

         /* Warning button styles */
         .btn-warning {
             background: linear-gradient(135deg, #ff9800, #f57c00) !important;
             color: white !important;
             border: none !important;
         }

         .btn-warning:hover {
             box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3) !important;
             transform: translateY(-2px);
         }
     `;
       document.head.appendChild(style);

       // Th√¥ng b√°o ch√†o m·ª´ng v·ªÅ h·ªá th·ªëng B1
       setTimeout(() => {
           if (document.getElementById('practice').classList.contains('active')) {
               showNotification('üéØ Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng luy·ªán nghe!', 'info');
           }
       }, 2000);

   </script>
</body>


</html>